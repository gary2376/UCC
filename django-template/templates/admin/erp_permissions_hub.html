{% extends "admin/base_site.html" %}
{% load i18n admin_urls static admin_list %}

{% block title %}{{ title }} | {{ site_title|default:_('Django site admin') }}{% endblock %}

{% block breadcrumbs %}
<div class="breadcrumbs">
<a href="{% url 'admin:index' %}">{% trans 'Home' %}</a>
&rsaquo; <a href="#/admin/erp/">ERP</a>
&rsaquo; {{ title }}
</div>
{% endblock %}

{% block extrahead %}
{{ block.super }}
<style>
.erp-permissions-hub {
    margin: 20px 0;
}

.highlighted-section {
    background: linear-gradient(135deg, #e3f2fd 0%, #f8f9fa 100%);
    border: 2px solid #2196f3;
    border-radius: 8px;
    margin-bottom: 20px;
}

.highlighted-section h2 {
    color: #1976d2;
    font-size: 1.5em;
    margin-bottom: 10px;
}

.quick-actions {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    margin: 15px 0;
}

.button.large {
    padding: 12px 20px;
    font-size: 14px;
    font-weight: bold;
    border-radius: 6px;
    text-decoration: none;
    display: inline-block;
    min-width: 150px;
    text-align: center;
    transition: all 0.3s ease;
}

.button.large:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.groups-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
    gap: 20px;
    margin: 20px 0;
}

.group-card {
    border: 1px solid #ddd;
    border-radius: 8px;
    padding: 20px;
    background: white;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    transition: all 0.3s ease;
}

.group-card:hover {
    box-shadow: 0 4px 16px rgba(0,0,0,0.15);
    transform: translateY(-2px);
}

.group-header h3 {
    margin: 0 0 10px 0;
    color: #333;
    font-size: 1.3em;
}

.group-stats {
    margin-bottom: 15px;
}

.group-stats .stat {
    display: inline-block;
    background: #f0f0f0;
    padding: 5px 10px;
    margin-right: 10px;
    border-radius: 20px;
    font-size: 12px;
    color: #666;
}

.group-actions {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
    margin-bottom: 10px;
}

.edit-btn { background: #4caf50; color: white; }
.quick-edit-btn { background: #ff9800; color: white; }
.info-btn { background: #2196f3; color: white; }
.delete-btn { background: #f44336; color: white; }
.disabled-btn { background: #ccc; color: #666; cursor: not-allowed; }

.button:hover:not(.disabled-btn) {
    opacity: 0.9;
    transform: translateY(-1px);
}

.disabled-btn:hover {
    transform: none;
    opacity: 1;
}

.permissions-list {
    margin-top: 10px;
}

.permission-tag {
    display: inline-block;
    background: #e8f5e8;
    color: #2e7d32;
    padding: 3px 8px;
    margin: 2px;
    border-radius: 12px;
    font-size: 11px;
    border: 1px solid #c8e6c9;
}

.no-groups {
    text-align: center;
    padding: 40px;
    background: #f9f9f9;
    border-radius: 8px;
    margin: 20px 0;
}

.no-groups h3 {
    color: #555;
    margin-bottom: 15px;
}

.create-group-form {
    background: #fff3e0;
    border: 1px solid #ffb74d;
    border-radius: 6px;
}

.users-summary {
    padding: 15px;
    background: #f5f5f5;
    border-radius: 6px;
}
</style>

<script>
function showCreateGroupForm() {
    document.getElementById('createGroupForm').style.display = 'block';
    document.getElementById('group_name').focus();
}

function hideCreateGroupForm() {
    document.getElementById('createGroupForm').style.display = 'none';
    document.getElementById('group_name').value = '';
}

function showPermissions(groupId) {
    var permDiv = document.getElementById('permissions-' + groupId);
    if (permDiv.style.display === 'none') {
        permDiv.style.display = 'block';
    } else {
        permDiv.style.display = 'none';
    }
}

function deleteGroup(groupId, groupName) {
    if (confirm('ç¢ºå®šè¦åˆªé™¤ç¾¤çµ„ "' + groupName + '" å—ï¼Ÿ')) {
        fetch('/admin/erp/ajax/delete-group/' + groupId + '/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'Content-Type': 'application/json',
            },
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById('group-' + groupId).remove();
                alert('ç¾¤çµ„å·²åˆªé™¤: ' + data.message);
                location.reload(); // é‡æ–°æ•´ç†é é¢ä»¥æ›´æ–°ç‹€æ…‹
            } else {
                alert('åˆªé™¤å¤±æ•—: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('åˆªé™¤æ™‚ç™¼ç”ŸéŒ¯èª¤');
        });
    }
}
</script>
{% endblock %}
<div class="erp-permissions-hub">
    <h1>{{ title }}</h1>
    
    <!-- é¡¯è‘—çš„ç¾¤çµ„ç®¡ç†å€åŸŸ -->
    <div class="module highlighted-section">
        <h2>ğŸ” ç¾¤çµ„æ¬Šé™ç®¡ç†</h2>
        <p style="margin-bottom: 15px; color: #666;">åœ¨é€™è£¡ç®¡ç†ä½¿ç”¨è€…ç¾¤çµ„å’Œæ¬Šé™è¨­å®š</p>
        
        <!-- å¿«é€Ÿæ“ä½œå€ -->
        <div class="quick-actions">
            <button onclick="showCreateGroupForm()" class="button default large">â• å‰µå»ºæ–°ç¾¤çµ„</button>
            <a href="#/admin/auth/group/" class="button large">ğŸ“‹ æŸ¥çœ‹æ‰€æœ‰ç¾¤çµ„</a>
            <a href="#/admin/erp/create-sample-groups/" class="button large">âš¡ å‰µå»ºç¤ºç¯„ç¾¤çµ„</a>
        </div>
    </div>

    <!-- å¿«é€Ÿå‰µå»ºç¾¤çµ„è¡¨å–® -->
    <div class="module create-group-form" id="createGroupForm" style="display: none;">
        <h2>å‰µå»ºæ–°ç¾¤çµ„</h2>
        <form method="post" style="padding: 15px;">
            {% csrf_token %}
            <input type="hidden" name="create_group" value="1">
            <div style="margin-bottom: 15px;">
                <label for="group_name" style="font-weight: bold;">ç¾¤çµ„åç¨±:</label>
                <input type="text" id="group_name" name="group_name" required 
                       style="width: 300px; padding: 8px; margin-left: 10px; border: 1px solid #ccc; border-radius: 4px;">
            </div>
            <div>
                <button type="submit" class="button default">å‰µå»ºç¾¤çµ„</button>
                <button type="button" onclick="hideCreateGroupForm()" class="button">å–æ¶ˆ</button>
            </div>
        </form>
    </div>

    <!-- ç¾¤çµ„ç®¡ç†å€ -->
    <div class="module">
        <h2>ç¾æœ‰ç¾¤çµ„ ({{ groups.count }} å€‹)</h2>
        
        {% if groups %}
        <div class="groups-grid">
            {% for group in groups %}
            <div class="group-card" id="group-{{ group.id }}">
                <div class="group-header">
                    <h3>{{ group.name }}</h3>
                    <div class="group-stats">
                        <span class="stat">ğŸ“ {{ group.permissions.count }} æ¬Šé™</span>
                        <span class="stat">ğŸ‘¥ {{ group.user_set.count }} ä½¿ç”¨è€…</span>
                    </div>
                </div>
                
                <div class="group-actions">
                    <a href="#/admin/auth/group/{{ group.pk }}/change/" class="button edit-btn" title="å®Œæ•´ç·¨è¼¯ç¾¤çµ„å’Œæ¬Šé™">âœï¸ å®Œæ•´ç·¨è¼¯</a>
                    <a href="#/admin/erp/group-edit/{{ group.pk }}/" class="button quick-edit-btn" title="å¿«é€Ÿç·¨è¼¯ç¾¤çµ„æ¬Šé™">âš¡ å¿«é€Ÿç·¨è¼¯</a>
                    <button onclick="showPermissions({{ group.pk }})" class="button info-btn" title="é¡¯ç¤º/éš±è—ç¾¤çµ„æ¬Šé™">ğŸ‘ï¸ æŸ¥çœ‹æ¬Šé™</button>
                    {% if group.user_set.count == 0 %}
                    <button onclick="deleteGroup({{ group.pk }}, '{{ group.name|escapejs }}')" class="button delete-btn" title="åˆªé™¤ç¾¤çµ„(åƒ…é™ç„¡ä½¿ç”¨è€…çš„ç¾¤çµ„)">ğŸ—‘ï¸ åˆªé™¤</button>
                    {% else %}
                    <span class="button disabled-btn" title="æ­¤ç¾¤çµ„æœ‰ {{ group.user_set.count }} å€‹ä½¿ç”¨è€…ï¼Œç„¡æ³•åˆªé™¤">ğŸ”’ æœ‰ä½¿ç”¨è€…</span>
                    {% endif %}
                </div>
                
                <div class="group-permissions" id="permissions-{{ group.id }}" style="display: none;">
                    <h4>ç›®å‰æ¬Šé™:</h4>
                    <div class="permissions-list">
                        {% for perm in group.permissions.all %}
                        <span class="permission-tag">{{ perm.name }}</span>
                        {% endfor %}
                        {% if not group.permissions.all %}
                        <p style="color: #999; font-style: italic;">æ­¤ç¾¤çµ„å°šæœªåˆ†é…ä»»ä½•æ¬Šé™</p>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="no-groups">
            <h3>ğŸš€ é–‹å§‹è¨­å®šæ¬Šé™ç¾¤çµ„</h3>
            <p>æ‚¨é‚„æ²’æœ‰å‰µå»ºä»»ä½•ç¾¤çµ„ã€‚å‰µå»ºç¾¤çµ„å¯ä»¥å¹«åŠ©æ‚¨æ›´å¥½åœ°ç®¡ç†ä½¿ç”¨è€…æ¬Šé™ã€‚</p>
            <button onclick="showCreateGroupForm()" class="button default large">å‰µå»ºç¬¬ä¸€å€‹ç¾¤çµ„</button>
            <p style="margin-top: 10px;">
                æˆ–è€… <a href="/admin/erp/create-sample-groups/">å‰µå»ºç¤ºç¯„ç¾¤çµ„</a> ä¾†å¿«é€Ÿé–‹å§‹
            </p>
        </div>
        {% endif %}
    </div>

    <!-- ä½¿ç”¨è€…æ¬Šé™ç®¡ç†é€£çµ -->
    <div class="module">
        <h2>ğŸ‘¤ ä½¿ç”¨è€…æ¬Šé™ç®¡ç†</h2>
        <div class="users-summary">
            <p>ç‚ºä½¿ç”¨è€…åˆ†é…ç¾¤çµ„ï¼Œæˆ–æª¢è¦–ç¾æœ‰çš„æ¬Šé™åˆ†é…ï¼š</p>
            <a href="#/admin/app/user/" class="button large">ç®¡ç†ä½¿ç”¨è€…æ¬Šé™</a>
            <a href="#/admin/auth/permission/" class="button">æŸ¥çœ‹æ‰€æœ‰ç³»çµ±æ¬Šé™</a>
        </div>
    </div>
</div>

<!-- åˆªé™¤ç¢ºèªå°è©±æ¡† -->
<div class="modal-overlay" id="deleteModal" style="display: none;">
    <div class="modal-content">
        <h3>ç¢ºèªåˆªé™¤</h3>
        <p id="deleteMessage"></p>
        <div class="modal-actions">
            <button id="confirmDelete" class="button delete-btn">ç¢ºèªåˆªé™¤</button>
            <button onclick="hideDeleteModal()" class="button">å–æ¶ˆ</button>
        </div>
    </div>
</div>

<style>
.erp-permissions-hub .module {
    margin-bottom: 20px;
}

.quick-actions {
    padding: 15px;
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
}

.button {
    padding: 8px 16px;
    text-decoration: none;
    background: #417690;
    color: white;
    border: none;
    border-radius: 4px;
    font-size: 12px;
    cursor: pointer;
}

.button:hover {
    background: #205067;
}

.button.default {
    background: #417690;
}

.button.tiny {
    padding: 4px 8px;
    font-size: 11px;
    margin-right: 5px;
}

.button.delete-btn {
    background: #dc3545;
}

.button.delete-btn:hover {
    background: #c82333;
}

.create-group-form {
    background: #f8f8f8;
    border-left: 4px solid #417690;
}

.groups-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 20px;
    padding: 15px;
}

.group-card {
    border: 1px solid #ddd;
    border-radius: 8px;
    padding: 15px;
    background: white;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.group-header h3 {
    margin: 0 0 10px 0;
    color: #417690;
    font-size: 16px;
}

.group-stats {
    display: flex;
    gap: 15px;
    margin-bottom: 15px;
}

.stat {
    background: #e9ecef;
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 12px;
    color: #495057;
}

.group-actions {
    display: flex;
    flex-wrap: wrap;
    gap: 5px;
    margin-bottom: 10px;
}

.permission-tag {
    background: #e1f5fe;
    color: #0277bd;
    padding: 2px 6px;
    border-radius: 12px;
    font-size: 10px;
    margin: 2px;
    display: inline-block;
}

.no-groups {
    grid-column: 1 / -1;
    text-align: center;
    padding: 40px;
    background: #f8f8f8;
    border-radius: 8px;
}

.modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    z-index: 1000;
    display: flex;
    align-items: center;
    justify-content: center;
}

.modal-content {
    background: white;
    padding: 30px;
    border-radius: 8px;
    max-width: 400px;
    width: 90%;
}

.modal-actions {
    display: flex;
    gap: 10px;
    justify-content: flex-end;
    margin-top: 20px;
}

.users-summary {
    padding: 15px;
    background: #f8f8f8;
    border-radius: 4px;
}
</style>

<script>
function showCreateGroupForm() {
    document.getElementById('createGroupForm').style.display = 'block';
    document.getElementById('group_name').focus();
}

function hideCreateGroupForm() {
    document.getElementById('createGroupForm').style.display = 'none';
}

function showPermissions(groupId) {
    const permDiv = document.getElementById('permissions-' + groupId);
    if (permDiv.style.display === 'none') {
        permDiv.style.display = 'block';
    } else {
        permDiv.style.display = 'none';
    }
}

function deleteGroup(groupId, groupName) {
    document.getElementById('deleteMessage').textContent = `æ‚¨ç¢ºå®šè¦åˆªé™¤ç¾¤çµ„ "${groupName}" å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•æ’¤éŠ·ã€‚`;
    document.getElementById('deleteModal').style.display = 'flex';
    
    document.getElementById('confirmDelete').onclick = function() {
        fetch(`/admin/erp/ajax/delete-group/${groupId}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById(`group-${groupId}`).remove();
                alert(data.message);
            } else {
                alert('éŒ¯èª¤: ' + data.error);
            }
            hideDeleteModal();
        })
        .catch(error => {
            alert('ç™¼ç”ŸéŒ¯èª¤: ' + error);
            hideDeleteModal();
        });
    };
}

function hideDeleteModal() {
    document.getElementById('deleteModal').style.display = 'none';
}
</script>
{% endblock %}
