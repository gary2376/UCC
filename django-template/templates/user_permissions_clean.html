{% load permission_filters %}
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>編輯用戶權限 - {{ target_user.username }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem 0;
            margin-bottom: 2rem;
        }
        .card {
            border: none;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }
        .feature-card {
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            transition: all 0.3s;
        }
        .feature-card:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .btn-primary {
            background: linear-gradient(45deg, #667eea, #764ba2);
            border: none;
            border-radius: 5px;
        }
        .btn-primary:hover {
            background: linear-gradient(45deg, #5a6fd8, #6a4190);
        }
        .navbar {
            background: rgba(255,255,255,0.95) !important;
            backdrop-filter: blur(10px);
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .form-check-input:checked {
            background-color: #667eea;
            border-color: #667eea;
        }
    </style>
</head>
<body>
    <!-- 導航欄 -->
    <nav class="navbar navbar-expand-lg navbar-light bg-light sticky-top">
        <div class="container">
            <a class="navbar-brand" href="{% url 'erp:permission_management' %}">
                <i class="fas fa-arrow-left me-2"></i>返回權限管理
            </a>
            <div class="navbar-nav ms-auto">
            </div>
        </div>
    </nav>

    <!-- 標題區 -->
    <div class="header">
        <div class="container">
            <h1 class="mb-0">
                <i class="fas fa-user-shield me-3"></i>編輯用戶權限
                <small class="d-block mt-2 opacity-75">{{ target_user.username }}</small>
            </h1>
        </div>
    </div>

    <div class="container">
        <div class="row">
            <!-- 用戶信息 -->
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header bg-white">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-user me-2"></i>用戶信息
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label text-muted">用戶名</label>
                            <div class="fw-bold">{{ target_user.username }}</div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label text-muted">姓名</label>
                            <div>{{ target_user.get_full_name|default:"未設定" }}</div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label text-muted">郵箱</label>
                            <div>{{ target_user.email|default:"未設定" }}</div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label text-muted">狀態</label>
                            <div>
                                {% if target_user.is_active %}
                                    <span class="badge bg-success">啟用</span>
                                {% else %}
                                    <span class="badge bg-danger">停用</span>
                                {% endif %}
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label text-muted">最後登入</label>
                            <div>
                                {% if target_user.last_login %}
                                    {{ target_user.last_login|date:"Y-m-d H:i" }}
                                {% else %}
                                    <span class="text-muted">從未登入</span>
                                {% endif %}
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label text-muted">加入日期</label>
                            <div>{{ target_user.date_joined|date:"Y-m-d" }}</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 權限設定 -->
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header bg-white d-flex justify-content-between align-items-center">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-shield-alt me-2"></i>功能權限設定
                        </h5>
                        <div>
                            <button type="button" class="btn btn-sm btn-outline-secondary me-1" onclick="selectAllPermissions('view')">
                                全選瀏覽
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-success me-1" onclick="selectAllPermissions('edit')">
                                全選編輯
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-danger" onclick="clearAllPermissions()">
                                清除全部
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <form id="permissionForm">
                            <div class="row">
                                {% for feature in features %}
                                <div class="col-md-6 mb-3">
                                    <div class="feature-card">
                                        <h6 class="mb-2">
                                            <i class="fas fa-cog text-primary me-2"></i>{{ feature.name }}
                                        </h6>
                                        {% if feature.description %}
                                            <p class="text-muted small mb-3">{{ feature.description }}</p>
                                        {% endif %}
                                        <div class="permission-options">
                                            <div class="form-check mb-2">
                                                <input class="form-check-input" type="radio" 
                                                       name="permission_{{ feature.code }}" 
                                                       id="none_{{ feature.code }}" 
                                                       value="none"
                                                       {% if not user_permissions|get_item:feature.code %}checked{% endif %}>
                                                <label class="form-check-label" for="none_{{ feature.code }}">
                                                    <span class="badge bg-secondary">無權限</span>
                                                </label>
                                            </div>
                                            <div class="form-check mb-2">
                                                <input class="form-check-input" type="radio" 
                                                       name="permission_{{ feature.code }}" 
                                                       id="view_{{ feature.code }}" 
                                                       value="view"
                                                       {% if user_permissions|get_item:feature.code == 'view' %}checked{% endif %}>
                                                <label class="form-check-label" for="view_{{ feature.code }}">
                                                    <span class="badge bg-info">瀏覽</span>
                                                </label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="radio" 
                                                       name="permission_{{ feature.code }}" 
                                                       id="edit_{{ feature.code }}" 
                                                       value="edit"
                                                       {% if user_permissions|get_item:feature.code == 'edit' %}checked{% endif %}>
                                                <label class="form-check-label" for="edit_{{ feature.code }}">
                                                    <span class="badge bg-success">編輯</span>
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                            
                            <div class="text-center mt-4">
                                <button type="button" class="btn btn-primary btn-lg me-3" onclick="savePermissions()">
                                    <i class="fas fa-save me-2"></i>儲存權限設定
                                </button>
                                <a href="{% url 'erp:permission_management' %}" class="btn btn-outline-secondary btn-lg">
                                    <i class="fas fa-times me-2"></i>取消
                                </a>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
    function selectAllPermissions(type) {
        const radios = document.querySelectorAll(`input[type="radio"][value="${type}"]`);
        radios.forEach(radio => {
            radio.checked = true;
        });
    }

    function clearAllPermissions() {
        const radios = document.querySelectorAll('input[type="radio"][value="none"]');
        radios.forEach(radio => {
            radio.checked = true;
        });
    }

    function savePermissions() {
        const form = document.getElementById('permissionForm');
        const formData = new FormData(form);
        const permissions = {};
        
        // 收集權限設定
        for (let [key, value] of formData.entries()) {
            if (key.startsWith('permission_') && value !== 'none') {
                const featureCode = key.replace('permission_', '');
                permissions[featureCode] = value;
            }
        }
        
        // 顯示儲存中狀態
        const saveBtn = document.querySelector('button[onclick="savePermissions()"]');
        const originalText = saveBtn.innerHTML;
        saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>儲存中...';
        saveBtn.disabled = true;
        
        // 發送更新請求
        fetch(`/erp/permissions/user/{{ target_user.id }}/update/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                permissions: permissions
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // 顯示成功訊息
                showAlert('success', data.message);
                
                // 延遲跳轉到列表頁面
                setTimeout(() => {
                    window.location.href = '{% url "erp:permission_management" %}';
                }, 1500);
            } else {
                showAlert('danger', data.message);
            }
        })
        .catch(error => {
            showAlert('danger', '儲存權限時發生錯誤，請稍後再試');
        })
        .finally(() => {
            // 恢復按鈕狀態
            saveBtn.innerHTML = originalText;
            saveBtn.disabled = false;
        });
    }

    function showAlert(type, message) {
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x`;
        alertDiv.style.zIndex = '9999';
        alertDiv.style.marginTop = '20px';
        alertDiv.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        document.body.appendChild(alertDiv);
        
        // 自動移除警告
        setTimeout(() => {
            if (alertDiv.parentNode) {
                alertDiv.parentNode.removeChild(alertDiv);
            }
        }, 5000);
    }

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    </script>
</body>
</html>
