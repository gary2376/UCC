{% extends 'erp/base.html' %}
{% load static %}

{% block title %}檔案上傳 - ERP 系統{% endblock %}

{% block breadcrumb_items %}
<li class="breadcrumb-item"><a href="{% url 'erp:dashboard' %}">儀表板</a></li>
<li class="breadcrumb-item active">檔案上傳</li>
{% endblock %}

{% block extra_css %}
<style>
    .upload-card {
        background: white;
        border-radius: 15px;
        padding: 30px;
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
        margin-bottom: 25px;
    }
    
    .upload-zone {
        border: 2px dashed #667eea;
        border-radius: 10px;
        padding: 40px;
        text-align: center;
        background: #f8f9ff;
        transition: all 0.3s ease;
        cursor: pointer;
    }
    
    .upload-zone:hover {
        border-color: #764ba2;
        background: #f0f2ff;
    }
    
    .upload-zone.dragover {
        border-color: #28a745;
        background: #f0fff4;
    }
    
    .upload-icon {
        font-size: 3rem;
        color: #667eea;
        margin-bottom: 20px;
    }
    
    .file-input {
        display: none;
    }
    
    .btn-upload {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: none;
        color: white;
        padding: 12px 30px;
        border-radius: 25px;
        font-weight: 500;
        transition: all 0.3s ease;
    }
    
    .btn-upload:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        color: white;
    }
    
    .btn-upload:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
    }
    
    .progress-container {
        display: none;
        margin-top: 20px;
    }
    
    .file-info {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 8px;
        margin-top: 15px;
        display: none;
    }
    
    .history-table {
        margin-top: 30px;
    }
    
    .status-badge {
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 0.875rem;
        font-weight: 500;
    }
    
    .status-success { background: #d4edda; color: #155724; }
    .status-failed { background: #f8d7da; color: #721c24; }
    .status-pending { background: #fff3cd; color: #856404; }
    .status-duplicate { background: #d1ecf1; color: #0c5460; }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pb-2 mb-3 border-bottom">
        <h1 class="h2">
            <i class="fas fa-upload me-2"></i>
            檔案上傳
        </h1>
    </div>

    <!-- 上傳區域 -->
    <div class="upload-card">
        <h4 class="mb-4">
            <i class="fas fa-file-excel text-success me-2"></i>
            Excel 檔案上傳
        </h4>
        
        <form id="uploadForm" enctype="multipart/form-data">
            {% csrf_token %}
            
            <!-- 檔案類型選擇 -->
            <div class="row mb-4">
                <div class="col-md-6">
                    <label class="form-label">選擇檔案類型</label>
                    <select name="file_type" id="fileType" class="form-select" required>
                        <option value="">請選擇...</option>
                        <option value="green_bean">生豆入庫記錄</option>
                        <option value="raw_material">原料倉管理</option>
                        <option value="monthly_summary">月度統計</option>
                    </select>
                </div>
            </div>
            
            <!-- 上傳區域 -->
            <div class="upload-zone" id="uploadZone">
                <div class="upload-icon">
                    <i class="fas fa-cloud-upload-alt"></i>
                </div>
                <h5>點擊或拖曳檔案到此處</h5>
                <p class="text-muted">支援 .xlsx 和 .xls 格式</p>
                <input type="file" name="file" id="fileInput" class="file-input" accept=".xlsx,.xls">
                <button type="button" class="btn btn-outline-primary" onclick="document.getElementById('fileInput').click()">
                    <i class="fas fa-folder-open me-2"></i>選擇檔案
                </button>
            </div>
            
            <!-- 檔案資訊 -->
            <div class="file-info" id="fileInfo">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <i class="fas fa-file-excel text-success me-2"></i>
                        <span id="fileName"></span>
                        <small class="text-muted">(<span id="fileSize"></span>)</small>
                    </div>
                    <button type="button" class="btn btn-sm btn-outline-danger" onclick="clearFile()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
            
            <!-- 進度條 -->
            <div class="progress-container" id="progressContainer">
                <div class="progress">
                    <div class="progress-bar" role="progressbar" style="width: 0%"></div>
                </div>
                <small class="text-muted mt-2">正在處理檔案...</small>
            </div>
            
            <!-- 上傳按鈕 -->
            <div class="text-center mt-4">
                <button type="submit" class="btn btn-upload" id="uploadBtn" disabled>
                    <i class="fas fa-upload me-2"></i>
                    開始上傳
                </button>
            </div>
        </form>
    </div>

    <!-- 最近上傳記錄 -->
    <div class="upload-card history-table">
        <h4 class="mb-4">
            <i class="fas fa-history me-2"></i>
            最近上傳記錄
        </h4>
        
        <div class="table-responsive">
            <table class="table table-hover">
                <thead class="table-light">
                    <tr>
                        <th>檔案名稱</th>
                        <th>類型</th>
                        <th>上傳時間</th>
                        <th>記錄數量</th>
                        <th>狀態</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody>
                    {% for upload in recent_uploads %}
                    <tr>
                        <td>
                            <i class="fas fa-file-excel text-success me-2"></i>
                            {{ upload.file_name }}
                        </td>
                        <td>
                            <span class="badge bg-secondary">{{ upload.get_file_type_display }}</span>
                        </td>
                        <td>{{ upload.upload_time|date:"Y-m-d H:i" }}</td>
                        <td>{{ upload.records_count }}</td>
                        <td>
                            <span class="status-badge status-{{ upload.status }}">
                                {{ upload.get_status_display }}
                            </span>
                        </td>
                        <td>
                            {% if upload.status == 'failed' and upload.error_message %}
                            <button class="btn btn-sm btn-outline-info" onclick="showError('{{ upload.error_message|escapejs }}')">
                                <i class="fas fa-info-circle"></i>
                            </button>
                            {% endif %}
                            <a href="{% url 'erp:upload_history' %}" class="btn btn-sm btn-outline-primary">
                                <i class="fas fa-eye"></i>
                            </a>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="6" class="text-center text-muted">暫無上傳記錄</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        <div class="text-center mt-3">
            <a href="{% url 'erp:upload_history' %}" class="btn btn-outline-primary">
                <i class="fas fa-list me-2"></i>
                查看所有記錄
            </a>
        </div>
    </div>
</div>

<!-- 錯誤訊息模態框 -->
<div class="modal fade" id="errorModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">錯誤詳情</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p id="errorMessage"></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">關閉</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // 檔案上傳處理
    document.addEventListener('DOMContentLoaded', function() {
        const uploadZone = document.getElementById('uploadZone');
        const fileInput = document.getElementById('fileInput');
        const fileInfo = document.getElementById('fileInfo');
        const fileName = document.getElementById('fileName');
        const fileSize = document.getElementById('fileSize');
        const uploadBtn = document.getElementById('uploadBtn');
        const fileType = document.getElementById('fileType');
        const uploadForm = document.getElementById('uploadForm');
        const progressContainer = document.getElementById('progressContainer');
        
        // 點擊上傳區域
        uploadZone.addEventListener('click', function(e) {
            if (e.target !== uploadZone && !uploadZone.contains(e.target)) return;
            fileInput.click();
        });
        
        // 拖拽處理
        uploadZone.addEventListener('dragover', function(e) {
            e.preventDefault();
            uploadZone.classList.add('dragover');
        });
        
        uploadZone.addEventListener('dragleave', function(e) {
            e.preventDefault();
            uploadZone.classList.remove('dragover');
        });
        
        uploadZone.addEventListener('drop', function(e) {
            e.preventDefault();
            uploadZone.classList.remove('dragover');
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                fileInput.files = files;
                handleFileSelect(files[0]);
            }
        });
        
        // 檔案選擇處理
        fileInput.addEventListener('change', function(e) {
            if (e.target.files.length > 0) {
                handleFileSelect(e.target.files[0]);
            }
        });
        
        // 檔案類型選擇
        fileType.addEventListener('change', function() {
            checkFormValid();
        });
        
        // 處理檔案選擇
        function handleFileSelect(file) {
            if (!file.name.toLowerCase().match(/\.(xlsx|xls)$/)) {
                alert('只支援 .xlsx 和 .xls 格式的檔案');
                return;
            }
            
            fileName.textContent = file.name;
            fileSize.textContent = formatFileSize(file.size);
            fileInfo.style.display = 'block';
            
            checkFormValid();
        }
        
        // 檢查表單有效性
        function checkFormValid() {
            const hasFile = fileInput.files.length > 0;
            const hasType = fileType.value !== '';
            
            uploadBtn.disabled = !(hasFile && hasType);
        }
        
        // 清除檔案
        window.clearFile = function() {
            fileInput.value = '';
            fileInfo.style.display = 'none';
            checkFormValid();
        };
        
        // 格式化檔案大小
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
        // 表單提交
        uploadForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            if (!fileInput.files.length || !fileType.value) {
                alert('請選擇檔案和檔案類型');
                return;
            }
            
            const formData = new FormData(uploadForm);
            
            // 顯示進度條
            progressContainer.style.display = 'block';
            uploadBtn.disabled = true;
            uploadBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>處理中...';
            
            fetch('{% url "erp:file_upload" %}', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                }
            })
            .then(response => response.json())
            .then(data => {
                progressContainer.style.display = 'none';
                uploadBtn.disabled = false;
                uploadBtn.innerHTML = '<i class="fas fa-upload me-2"></i>開始上傳';
                
                if (data.success) {
                    alert(`上傳成功！處理了 ${data.records_count} 筆記錄`);
                    location.reload();
                } else {
                    if (data.duplicate) {
                        const existing = data.existing_file;
                        alert(`檔案重複：此檔案「${existing.name}」已於 ${existing.upload_time} 上傳過，包含 ${existing.records_count} 筆記錄`);
                    } else {
                        alert('上傳失敗：' + data.message);
                    }
                }
            })
            .catch(error => {
                progressContainer.style.display = 'none';
                uploadBtn.disabled = false;
                uploadBtn.innerHTML = '<i class="fas fa-upload me-2"></i>開始上傳';
                alert('上傳失敗：' + error.message);
            });
        });
    });
    
    // 顯示錯誤訊息
    function showError(message) {
        document.getElementById('errorMessage').textContent = message;
        new bootstrap.Modal(document.getElementById('errorModal')).show();
    }
</script>
{% endblock %}
