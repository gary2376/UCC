{% extends 'erp/base.html' %}
{% load static %}

{% block title %}上傳歷史 - ERP 系統{% endblock %}

{% block breadcrumb_items %}
<li class="breadcrumb-item"><a href="{% url 'erp:dashboard' %}">儀表板</a></li>
<li class="breadcrumb-item"><a href="{% url 'erp:file_upload' %}">檔案上傳</a></li>
<li class="breadcrumb-item active">上傳歷史</li>
{% endblock %}

{% block extra_css %}
<style>
    .history-card {
        background: white;
        border-radius: 15px;
        padding: 30px;
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
        margin-bottom: 25px;
    }
    
    .status-badge {
        padding: 6px 15px;
        border-radius: 20px;
        font-size: 0.875rem;
        font-weight: 500;
    }
    
    .status-success { background: #d4edda; color: #155724; }
    .status-failed { background: #f8d7da; color: #721c24; }
    .status-pending { background: #fff3cd; color: #856404; }
    .status-duplicate { background: #d1ecf1; color: #0c5460; }
    
    .file-type-badge {
        padding: 4px 12px;
        border-radius: 15px;
        font-size: 0.8rem;
        font-weight: 500;
    }
    
    .type-green-bean { background: #d4edda; color: #155724; }
    .type-raw-material { background: #cce5ff; color: #004085; }
    .type-monthly-summary { background: #fff3cd; color: #856404; }
    
    .table-hover tbody tr:hover {
        background-color: #f8f9fa;
    }
    
    .btn-action {
        padding: 4px 8px;
        font-size: 0.875rem;
        border-radius: 4px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pb-2 mb-3 border-bottom">
        <h1 class="h2">
            <i class="fas fa-history me-2"></i>
            上傳歷史記錄
        </h1>
        <div class="btn-toolbar mb-2 mb-md-0">
            <a href="{% url 'erp:file_upload' %}" class="btn btn-primary">
                <i class="fas fa-upload me-2"></i>
                上傳新檔案
            </a>
        </div>
    </div>

    <!-- 統計資訊 -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4>{{ uploads|length }}</h4>
                            <p class="mb-0">總上傳次數</p>
                        </div>
                        <div>
                            <i class="fas fa-upload fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4>{{ uploads|length }}</h4>
                            <p class="mb-0">成功上傳</p>
                        </div>
                        <div>
                            <i class="fas fa-check-circle fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-warning text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4>0</h4>
                            <p class="mb-0">處理中</p>
                        </div>
                        <div>
                            <i class="fas fa-clock fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-danger text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4>0</h4>
                            <p class="mb-0">失敗</p>
                        </div>
                        <div>
                            <i class="fas fa-times-circle fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 上傳記錄表格 -->
    <div class="history-card">
        <div class="table-responsive">
            <table class="table table-hover">
                <thead class="table-light">
                    <tr>
                        <th>檔案名稱</th>
                        <th>檔案類型</th>
                        <th>檔案大小</th>
                        <th>上傳時間</th>
                        <th>上傳者</th>
                        <th>記錄數量</th>
                        <th>狀態</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody>
                    {% for upload in uploads %}
                    <tr>
                        <td>
                            <div class="d-flex align-items-center">
                                <i class="fas fa-file-excel text-success me-2"></i>
                                <div>
                                    <div class="fw-bold">{{ upload.file_name }}</div>
                                    <small class="text-muted">{{ upload.file_hash|slice:":8" }}...</small>
                                </div>
                            </div>
                        </td>
                        <td>
                            <span class="file-type-badge type-{{ upload.file_type }}">
                                {{ upload.get_file_type_display }}
                            </span>
                        </td>
                        <td>
                            <span class="text-muted">
                                {% if upload.file_size < 1024 %}
                                    {{ upload.file_size }} B
                                {% elif upload.file_size < 1048576 %}
                                    {{ upload.file_size|floatformat:1|div:1024 }} KB
                                {% else %}
                                    {{ upload.file_size|floatformat:1|div:1048576 }} MB
                                {% endif %}
                            </span>
                        </td>
                        <td>
                            <div>
                                <div>{{ upload.upload_time|date:"Y-m-d" }}</div>
                                <small class="text-muted">{{ upload.upload_time|date:"H:i:s" }}</small>
                            </div>
                        </td>
                        <td>
                            {% if upload.uploaded_by %}
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-user-circle me-2"></i>
                                    {{ upload.uploaded_by.get_full_name|default:upload.uploaded_by.username }}
                                </div>
                            {% else %}
                                <span class="text-muted">匿名用戶</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if upload.records_count > 0 %}
                                <span class="badge bg-info">{{ upload.records_count }}</span>
                            {% else %}
                                <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                        <td>
                            <span class="status-badge status-{{ upload.status }}">
                                <i class="fas 
                                    {% if upload.status == 'success' %}fa-check-circle
                                    {% elif upload.status == 'failed' %}fa-times-circle
                                    {% elif upload.status == 'pending' %}fa-clock
                                    {% elif upload.status == 'duplicate' %}fa-copy
                                    {% endif %} me-1"></i>
                                {{ upload.get_status_display }}
                            </span>
                        </td>
                        <td>
                            <div class="btn-group" role="group">
                                {% if upload.status == 'failed' and upload.error_message %}
                                <button class="btn btn-action btn-outline-info" 
                                        onclick="showError('{{ upload.error_message|escapejs }}')">
                                    <i class="fas fa-info-circle"></i>
                                </button>
                                {% endif %}
                                
                                <button class="btn btn-action btn-outline-danger" 
                                        onclick="deleteRecord('{{ upload.id }}', '{{ upload.file_name }}')">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="8" class="text-center text-muted py-5">
                            <i class="fas fa-inbox fa-3x mb-3"></i>
                            <div>暫無上傳記錄</div>
                            <div class="mt-3">
                                <a href="{% url 'erp:file_upload' %}" class="btn btn-primary">
                                    <i class="fas fa-upload me-2"></i>
                                    開始上傳檔案
                                </a>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- 錯誤訊息模態框 -->
<div class="modal fade" id="errorModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-exclamation-triangle text-warning me-2"></i>
                    錯誤詳情
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-danger">
                    <pre id="errorMessage" style="white-space: pre-wrap; margin: 0;"></pre>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">關閉</button>
            </div>
        </div>
    </div>
</div>

<!-- 刪除確認模態框 -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-trash text-danger me-2"></i>
                    確認刪除
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>確定要刪除上傳記錄嗎？</p>
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    檔案名稱：<strong id="deleteFileName"></strong>
                </div>
                <p class="text-muted">此操作只會刪除上傳記錄，不會影響已匯入的資料。</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">
                    <i class="fas fa-trash me-2"></i>確認刪除
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let deleteRecordId = null;
    
    // 顯示錯誤訊息
    function showError(message) {
        document.getElementById('errorMessage').textContent = message;
        new bootstrap.Modal(document.getElementById('errorModal')).show();
    }
    
    // 刪除記錄
    function deleteRecord(recordId, fileName) {
        deleteRecordId = recordId;
        document.getElementById('deleteFileName').textContent = fileName;
        new bootstrap.Modal(document.getElementById('deleteModal')).show();
    }
    
    // 確認刪除
    document.getElementById('confirmDeleteBtn').addEventListener('click', function() {
        if (!deleteRecordId) return;
        
        fetch(`/erp/upload/${deleteRecordId}/delete/`, {
            method: 'DELETE',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('刪除失敗：' + data.message);
            }
        })
        .catch(error => {
            alert('刪除失敗：' + error.message);
        });
        
        bootstrap.Modal.getInstance(document.getElementById('deleteModal')).hide();
    });
</script>
{% endblock %}
