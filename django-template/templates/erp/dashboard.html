{% extends 'admin/base.html' %}
{% load static %}

{% block title %}ERP 系統儀表板{% endblock %}

{% block extrahead %}
    {{ block.super }}
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .dashboard-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
            transition: transform 0.3s ease;
        }
        
        .dashboard-card:hover {
            transform: translateY(-5px);
        }
        
        .dashboard-card.warning {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }
        .dashboard-card.success {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }
        .dashboard-card.info {
            background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
        }
        
        .content-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }
        
        .chart-container {
            position: relative;
            height: 300px;
        }
        
        .dashboard-table {
            background: white;
        }
        
        .dashboard-table th {
            border-bottom: 2px solid #dee2e6;
            font-weight: 600;
        }
        
        .dashboard-table td {
            border-bottom: 1px solid #f1f3f4;
        }
        
        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 500;
        }
        
        .status-normal {
            background-color: #d4edda;
            color: #155724;
        }
        
        .status-abnormal {
            background-color: #f8d7da;
            color: #721c24;
        }
        
        .activity-item {
            border-left: 3px solid #007bff;
            background: #f8f9fa;
            padding: 10px 15px;
            margin-bottom: 8px;
            border-radius: 0 8px 8px 0;
        }
        
        .activity-item.create {
            border-left-color: #28a745;
        }
        
        .activity-item.update {
            border-left-color: #ffc107;
        }
        
        .activity-item.delete {
            border-left-color: #dc3545;
        }
        
        .activity-item.upload {
            border-left-color: #17a2b8;
        }
    </style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-3">
    <div class="row">
        <!-- 統計卡片 -->
        {% if user_permissions.green_bean %}
        <div class="col-lg-3 col-md-6">
            <div class="dashboard-card success">
                <div class="d-flex justify-content-between">
                    <div>
                        <h3 class="mb-0">{{ stats.total_green_bean_records|default:0 }}</h3>
                        <p class="mb-0">總生豆入庫記錄</p>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-seedling fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-3 col-md-6">
            <div class="dashboard-card warning">
                <div class="d-flex justify-content-between">
                    <div>
                        <h3 class="mb-0">{{ stats.recent_abnormal_records|default:0 }}</h3>
                        <p class="mb-0">異常記錄</p>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-exclamation-triangle fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-3 col-md-6">
            <div class="dashboard-card info">
                <div class="d-flex justify-content-between">
                    <div>
                        <h3 class="mb-0">{{ stats.current_month_green_bean_records|default:0 }}</h3>
                        <p class="mb-0">本月生豆記錄</p>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-calendar-month fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        {% if user_permissions.raw_material %}
        <div class="col-lg-3 col-md-6">
            <div class="dashboard-card">
                <div class="d-flex justify-content-between">
                    <div>
                        <h3 class="mb-0">{{ stats.total_raw_material_records|default:0 }}</h3>
                        <p class="mb-0">總原料倉記錄</p>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-warehouse fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
    </div>

    <!-- 記錄數量趨勢圖 -->
    <div class="row">
        <!-- 生豆入庫記錄趨勢 -->
        {% if user_permissions.green_bean %}
        <div class="col-lg-6">
            <div class="content-card">
                <h4 class="mb-4">
                    <i class="fas fa-chart-line text-success me-2"></i> 
                    生豆入庫記錄趨勢
                </h4>
                <div class="chart-container">
                    <canvas id="greenBeanChart"></canvas>
                </div>
            </div>
        </div>
        {% endif %}
        
        <!-- 原料倉記錄趨勢 -->
        {% if user_permissions.raw_material %}
        <div class="col-lg-6">
            <div class="content-card">
                <h4 class="mb-4">
                    <i class="fas fa-chart-line text-primary me-2"></i> 
                    原料倉管理記錄趨勢
                </h4>
                <div class="chart-container">
                    <canvas id="rawMaterialChart"></canvas>
                </div>
            </div>
        </div>
        {% endif %}
    </div>

    <div class="row">
        <!-- 最近記錄 -->
        {% if user_permissions.green_bean %}
        <div class="col-lg-8">
            <div class="content-card">
                <h4 class="mb-4">
                    <i class="fas fa-history text-primary me-2"></i> 
                    最近生豆入庫記錄
                </h4>
                <div class="table-responsive">
                    <table class="table dashboard-table table-hover">
                        <thead class="table-primary">
                            <tr>
                                <th>記錄時間</th>
                                <th>單號</th>
                                <th>生豆料號</th>
                                <th>生豆名稱</th>
                                <th>生豆批號</th>
                                <th>量測重量(kg)</th>
                                <th>投入袋數</th>
                                <th>入庫筒倉</th>
                                <th>執行狀態</th>
                                <th>狀態</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for record in recent_green_bean_records %}
                            <tr>
                                <td>{{ record.record_time|date:"m-d H:i" }}</td>
                                <td>{{ record.order_number }}</td>
                                <td>{{ record.green_bean_code|default:"-" }}</td>
                                <td>{{ record.green_bean_name }}</td>
                                <td>{{ record.green_bean_batch_number|default:"-" }}</td>
                                <td>{{ record.measured_weight_kg|default:"-" }}</td>
                                <td>{{ record.input_bag_count|default:"-" }}</td>
                                <td>{{ record.green_bean_storage_silo|default:"-" }}</td>
                                <td>{{ record.execution_status|default:"-" }}</td>
                                <td>
                                    {% if record.is_abnormal %}
                                        <span class="status-badge status-abnormal">異常</span>
                                    {% else %}
                                        <span class="status-badge status-normal">正常</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="10" class="text-center text-muted">暫無記錄</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- 庫存警示 -->
        {% if user_permissions.raw_material %}
        <div class="col-lg-4">
            <div class="content-card">
                <h4 class="mb-4">
                    <i class="fas fa-exclamation-triangle text-warning me-2"></i> 
                    低庫存警示
                </h4>
                {% for item in low_inventory_items %}
                <div class="alert alert-warning d-flex justify-content-between align-items-center">
                    <div>
                        <strong>{{ item.product_name }}</strong><br>
                        <small>{{ item.product_code }}</small>
                    </div>
                    <span class="badge bg-warning text-dark">{{ item.current_inventory }}</span>
                </div>
                {% empty %}
                <div class="text-center text-muted">
                    <i class="fas fa-check-circle fa-2x mb-2"></i>
                    <p>庫存充足</p>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // 初始化圖表
    initializeCharts();
});

// 初始化圖表
function initializeCharts() {
    // 從後端獲取圖表數據
    const chartsData = JSON.parse('{{ weekly_charts_data|escapejs }}');
    
    // 生豆入庫記錄趨勢圖
    {% if user_permissions.green_bean %}
    const greenBeanCtx = document.getElementById('greenBeanChart');
    if (greenBeanCtx) {
        new Chart(greenBeanCtx, {
            type: 'line',
            data: {
                labels: chartsData.weeks,
                datasets: [{
                    label: '生豆入庫記錄數',
                    data: chartsData.green_bean_data,
                    borderColor: '#28a745',
                    backgroundColor: 'rgba(40, 167, 69, 0.1)',
                    borderWidth: 3,
                    fill: true,
                    tension: 0.4,
                    pointBackgroundColor: '#28a745',
                    pointBorderColor: '#ffffff',
                    pointBorderWidth: 2,
                    pointRadius: 6,
                    pointHoverRadius: 8
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: true,
                        position: 'top'
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        titleColor: '#ffffff',
                        bodyColor: '#ffffff',
                        borderColor: '#28a745',
                        borderWidth: 1
                    }
                },
                scales: {
                    x: {
                        display: true,
                        title: {
                            display: true,
                            text: '日期',
                            font: {
                                size: 12,
                                weight: 'bold'
                            }
                        },
                        grid: {
                            color: 'rgba(0, 0, 0, 0.1)'
                        }
                    },
                    y: {
                        display: true,
                        title: {
                            display: true,
                            text: '記錄數量',
                            font: {
                                size: 12,
                                weight: 'bold'
                            }
                        },
                        beginAtZero: true,
                        grid: {
                            color: 'rgba(0, 0, 0, 0.1)'
                        },
                        ticks: {
                            stepSize: 1
                        }
                    }
                },
                interaction: {
                    mode: 'nearest',
                    axis: 'x',
                    intersect: false
                },
                elements: {
                    point: {
                        hoverBackgroundColor: '#ffffff'
                    }
                }
            }
        });
    }
    {% endif %}
    
    // 原料倉記錄趨勢圖
    {% if user_permissions.raw_material %}
    const rawMaterialCtx = document.getElementById('rawMaterialChart');
    if (rawMaterialCtx) {
        new Chart(rawMaterialCtx, {
            type: 'line',
            data: {
                labels: chartsData.weeks,
                datasets: [{
                    label: '原料倉記錄數',
                    data: chartsData.raw_material_data,
                    borderColor: '#007bff',
                    backgroundColor: 'rgba(0, 123, 255, 0.1)',
                    borderWidth: 3,
                    fill: true,
                    tension: 0.4,
                    pointBackgroundColor: '#007bff',
                    pointBorderColor: '#ffffff',
                    pointBorderWidth: 2,
                    pointRadius: 6,
                    pointHoverRadius: 8
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: true,
                        position: 'top'
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        titleColor: '#ffffff',
                        bodyColor: '#ffffff',
                        borderColor: '#007bff',
                        borderWidth: 1
                    }
                },
                scales: {
                    x: {
                        display: true,
                        title: {
                            display: true,
                            text: '日期',
                            font: {
                                size: 12,
                                weight: 'bold'
                            }
                        },
                        grid: {
                            color: 'rgba(0, 0, 0, 0.1)'
                        }
                    },
                    y: {
                        display: true,
                        title: {
                            display: true,
                            text: '記錄數量',
                            font: {
                                size: 12,
                                weight: 'bold'
                            }
                        },
                        beginAtZero: true,
                        grid: {
                            color: 'rgba(0, 0, 0, 0.1)'
                        },
                        ticks: {
                            stepSize: 1
                        }
                    }
                },
                interaction: {
                    mode: 'nearest',
                    axis: 'x',
                    intersect: false
                },
                elements: {
                    point: {
                        hoverBackgroundColor: '#ffffff'
                    }
                }
            }
        });
    }
    {% endif %}
}
</script>
{% endblock %}
