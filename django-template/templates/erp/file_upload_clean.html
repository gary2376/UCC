<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>檔案上傳 - ERP 系統</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            font-family: 'Arial', sans-serif;
            min-height: 100vh;
        }
        
        .upload-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 0;
            margin-bottom: 30px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .upload-card {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
            margin-bottom: 25px;
        }
        
        .upload-zone {
            border: 2px dashed #667eea;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            background: #f8f9ff;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .upload-zone:hover {
            border-color: #764ba2;
            background: #f0f2ff;
        }
        
        .upload-zone.dragover {
            border-color: #28a745;
            background: #f0fff4;
        }
        
        .upload-icon {
            font-size: 3rem;
            color: #667eea;
            margin-bottom: 20px;
        }
        
        .file-input {
            display: none;
        }
        
        .btn-upload {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            color: white;
            padding: 12px 30px;
            border-radius: 25px;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .btn-upload:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
            color: white;
        }
        
        .btn-upload:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .progress-container {
            display: none;
            margin-top: 20px;
        }
        
        .file-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            display: none;
        }
        
        .history-table {
            margin-top: 30px;
        }
        
        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.875rem;
            font-weight: 500;
        }
        
        .status-success { background: #d4edda; color: #155724; }
        .status-failed { background: #f8d7da; color: #721c24; }
        .status-pending { background: #fff3cd; color: #856404; }
        .status-duplicate { background: #d1ecf1; color: #0c5460; }
        
        .navbar-brand {
            font-weight: bold;
            font-size: 1.5rem;
        }
        
        .btn-nav {
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
            margin-left: 10px;
        }
        
        .btn-nav:hover {
            background: rgba(255,255,255,0.1);
            color: white;
        }
    </style>
</head>
<body>
    <!-- 頂部導航 -->
    <nav class="navbar navbar-expand-lg upload-header">
        <div class="container">
            <span class="navbar-brand">
                <i class="fas fa-upload me-2"></i>
                檔案上傳管理
            </span>
            <div class="ms-auto">
                <a href="/erp/clean/" class="btn btn-nav btn-sm">
                    <i class="fas fa-chart-line me-1"></i> 返回儀表板
                </a>
                <a href="/erp/upload/history/" class="btn btn-nav btn-sm">
                    <i class="fas fa-history me-1"></i> 上傳歷史
                </a>
                <button type="button" class="btn btn-nav btn-sm" onclick="location.reload()">
                    <i class="fas fa-sync-alt me-1"></i> 刷新
                </button>
            </div>
        </div>
    </nav>

    <!-- 主要內容 -->
    <div class="container">
        <!-- CSRF Token for AJAX requests -->
        <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">
        
        <!-- 上傳區域 -->
        <div class="upload-card">
            <h4 class="mb-4">
                <i class="fas fa-file-excel text-success me-2"></i>
                Excel 檔案上傳
            </h4>
            
            <form id="uploadForm" enctype="multipart/form-data">
                {% csrf_token %}
                
                <!-- 檔案類型選擇 -->
                <div class="row mb-4">
                    <div class="col-md-6">
                        <label class="form-label">選擇檔案類型</label>
                        <select name="file_type" id="fileType" class="form-select" required>
                            <option value="">請選擇...</option>
                            <option value="green_bean">生豆入庫記錄</option>
                            <option value="raw_material">原料倉管理</option>
                            <option value="monthly_summary">月度統計</option>
                        </select>
                    </div>
                </div>
                
                <!-- 上傳區域 -->
                <div class="upload-zone" id="uploadZone">
                    <div class="upload-icon">
                        <i class="fas fa-cloud-upload-alt"></i>
                    </div>
                    <h5>點擊或拖曳檔案到此處</h5>
                    <p class="text-muted">支援 .xlsx 和 .xls 格式</p>
                    <input type="file" name="file" id="fileInput" class="file-input" accept=".xlsx,.xls">
                    <button type="button" class="btn btn-outline-primary" id="selectFileBtn">
                        <i class="fas fa-folder-open me-2"></i>選擇檔案
                    </button>
                </div>
                
                <!-- 檔案資訊 -->
                <div class="file-info" id="fileInfo">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <i class="fas fa-file-excel text-success me-2"></i>
                            <span id="fileName"></span>
                            <small class="text-muted">(<span id="fileSize"></span>)</small>
                        </div>
                        <button type="button" class="btn btn-sm btn-outline-danger" onclick="clearFile()">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
                
                <!-- 進度條 -->
                <div class="progress-container" id="progressContainer">
                    <div class="progress">
                        <div class="progress-bar" role="progressbar" style="width: 0%"></div>
                    </div>
                    <small class="text-muted mt-2">正在處理檔案...</small>
                </div>
                
                <!-- 上傳按鈕 -->
                <div class="text-center mt-4">
                    <div class="d-flex gap-2 justify-content-center">
                        <button type="submit" class="btn btn-upload" id="uploadBtn" disabled>
                            <i class="fas fa-upload me-2"></i>
                            開始上傳
                        </button>
                    </div>
                </div>
            </form>
        </div>

        <!-- 最近上傳記錄 -->
        <div class="upload-card history-table">
            <h4 class="mb-4">
                <i class="fas fa-history me-2"></i>
                最近上傳記錄
            </h4>
            
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead class="table-light">
                        <tr>
                            <th>檔案名稱</th>
                            <th>類型</th>
                            <th>上傳時間</th>
                            <th>記錄數量</th>
                            <th>狀態</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for upload in recent_uploads %}
                        <tr>
                            <td>
                                <i class="fas fa-file-excel text-success me-2"></i>
                                {{ upload.file_name }}
                            </td>
                            <td>
                                <span class="badge bg-secondary">{{ upload.get_file_type_display }}</span>
                            </td>
                            <td>{{ upload.upload_time|date:"Y-m-d H:i" }}</td>
                            <td>{{ upload.records_count }}</td>
                            <td>
                                <span class="status-badge status-{{ upload.status }}">
                                    {{ upload.get_status_display }}
                                </span>
                            </td>
                            <td>
                                {% if upload.status == 'failed' and upload.error_message %}
                                <button class="btn btn-sm btn-outline-info me-1" onclick="showError('{{ upload.error_message|escapejs }}')" title="查看錯誤">
                                    <i class="fas fa-info-circle"></i>
                                </button>
                                {% endif %}
                                <button class="btn btn-sm btn-outline-danger" onclick="deleteQuickRecord('{{ upload.id }}')" title="刪除記錄">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="6" class="text-center text-muted">暫無上傳記錄</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            
            <div class="text-center mt-3">
                <a href="/erp/upload/history/" class="btn btn-outline-primary">
                    <i class="fas fa-list me-2"></i>
                    查看所有記錄
                </a>
            </div>
        </div>
    </div>

    <!-- 錯誤訊息模態框 -->
    <div class="modal fade" id="errorModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">錯誤詳情</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p id="errorMessage"></p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">關閉</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 分析結果模態框 -->
    <div class="modal fade" id="analysisModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-chart-bar me-2"></i>
                        檔案分析結果
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <pre id="analysisContent" style="white-space: pre-wrap; font-family: monospace; font-size: 0.9rem; max-height: 400px; overflow-y: auto;"></pre>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">關閉</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // 檔案上傳處理
        document.addEventListener('DOMContentLoaded', function() {
            const uploadZone = document.getElementById('uploadZone');
            const fileInput = document.getElementById('fileInput');
            const selectFileBtn = document.getElementById('selectFileBtn');
            const fileInfo = document.getElementById('fileInfo');
            const fileName = document.getElementById('fileName');
            const fileSize = document.getElementById('fileSize');
            const uploadBtn = document.getElementById('uploadBtn');
            const fileType = document.getElementById('fileType');
            const uploadForm = document.getElementById('uploadForm');
            const progressContainer = document.getElementById('progressContainer');
            
            // 檔案選擇狀態控制
            let isFileDialogOpen = false;
            
            // 點擊選擇檔案按鈕
            selectFileBtn.addEventListener('click', function(e) {
                e.stopPropagation(); // 防止事件冒泡
                if (isFileDialogOpen) {
                    console.log('檔案對話框已開啟，忽略重複點擊');
                    return;
                }
                console.log('點擊選擇檔案按鈕');
                isFileDialogOpen = true;
                fileInput.click();
                
                // 重置狀態（防止對話框取消後無法再次開啟）
                setTimeout(function() {
                    isFileDialogOpen = false;
                }, 1000);
            });
            
            // 點擊上傳區域（但不包括按鈕）
            uploadZone.addEventListener('click', function(e) {
                // 如果點擊的是按鈕或按鈕內的元素，則不處理
                if (e.target === selectFileBtn || selectFileBtn.contains(e.target)) {
                    return;
                }
                if (isFileDialogOpen) {
                    console.log('檔案對話框已開啟，忽略重複點擊');
                    return;
                }
                console.log('點擊上傳區域');
                isFileDialogOpen = true;
                fileInput.click();
                
                // 重置狀態
                setTimeout(function() {
                    isFileDialogOpen = false;
                }, 1000);
            });
            
            // 拖拽處理
            uploadZone.addEventListener('dragover', function(e) {
                e.preventDefault();
                uploadZone.classList.add('dragover');
            });
            
            uploadZone.addEventListener('dragleave', function(e) {
                e.preventDefault();
                uploadZone.classList.remove('dragover');
            });
            
            uploadZone.addEventListener('drop', function(e) {
                e.preventDefault();
                uploadZone.classList.remove('dragover');
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    // 建立新的 DataTransfer 物件來設定檔案
                    const dataTransfer = new DataTransfer();
                    dataTransfer.items.add(files[0]);
                    fileInput.files = dataTransfer.files;
                    handleFileSelect(files[0]);
                }
            });
            
            // 檔案選擇處理（添加防抖）
            let fileSelectTimeout;
            fileInput.addEventListener('change', function(e) {
                // 重置對話框狀態
                isFileDialogOpen = false;
                
                // 清除之前的超時
                if (fileSelectTimeout) {
                    clearTimeout(fileSelectTimeout);
                }
                
                // 延遲處理以避免重複觸發
                fileSelectTimeout = setTimeout(function() {
                    if (e.target.files.length > 0) {
                        console.log('檔案已選擇:', e.target.files[0].name);
                        handleFileSelect(e.target.files[0]);
                    }
                }, 100);
            });
            
            // 處理檔案對話框取消的情況
            let focusTimeout;
            window.addEventListener('focus', function() {
                if (isFileDialogOpen) {
                    // 延遲檢查，如果沒有檔案被選擇，則重置狀態
                    if (focusTimeout) clearTimeout(focusTimeout);
                    focusTimeout = setTimeout(function() {
                        if (isFileDialogOpen && fileInput.files.length === 0) {
                            console.log('檔案對話框可能被取消');
                            isFileDialogOpen = false;
                        }
                    }, 300);
                }
            });
            
            // 檔案類型選擇
            fileType.addEventListener('change', function() {
                checkFormValid();
            });
            
            // 處理檔案選擇
            function handleFileSelect(file) {
                if (!file.name.toLowerCase().match(/\.(xlsx|xls)$/)) {
                    alert('只支援 .xlsx 和 .xls 格式的檔案');
                    return;
                }
                
                fileName.textContent = file.name;
                fileSize.textContent = formatFileSize(file.size);
                fileInfo.style.display = 'block';
                
                checkFormValid();
            }
            
            // 檢查表單有效性
            function checkFormValid() {
                const hasFile = fileInput.files.length > 0;
                const hasType = fileType.value !== '';
                
                uploadBtn.disabled = !(hasFile && hasType);
            }
            
            // 清除檔案
            window.clearFile = function() {
                fileInput.value = '';
                fileInfo.style.display = 'none';
                checkFormValid();
            };
            
            // 格式化檔案大小
            function formatFileSize(bytes) {
                if (bytes === 0) return '0 Bytes';
                const k = 1024;
                const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            }
            
            // 表單提交（確保只綁定一次）
            uploadForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                console.log('表單提交開始');
                console.log('檔案數量:', fileInput.files.length);
                console.log('檔案類型選擇:', fileType.value);
                
                // 防止重複提交
                if (uploadBtn.disabled) {
                    console.log('按鈕已禁用，忽略提交');
                    return;
                }
                
                if (!fileInput.files.length || !fileType.value) {
                    alert('請選擇檔案和檔案類型');
                    return;
                }
                
                const formData = new FormData(uploadForm);
                console.log('FormData 創建完成');
                
                // 顯示進度條
                progressContainer.style.display = 'block';
                uploadBtn.disabled = true;
                uploadBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>處理中...';
                
                console.log('開始發送請求');
                fetch('/erp/upload/', {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                    }
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('網路錯誤: ' + response.status);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('收到回應:', data);
                    progressContainer.style.display = 'none';
                    uploadBtn.disabled = false;
                    uploadBtn.innerHTML = '<i class="fas fa-upload me-2"></i>開始上傳';
                    
                    if (data.success) {
                        console.log('上傳成功');
                        alert('上傳成功！處理了 ' + data.records_count + ' 筆記錄');
                        // 清空表單
                        uploadForm.reset();
                        fileInfo.style.display = 'none';
                        checkFormValid();
                        // 重新載入頁面
                        setTimeout(function() {
                            location.reload();
                        }, 1000);
                    } else {
                        console.log('上傳失敗:', data.message);
                        if (data.duplicate) {
                            const existing = data.existing_file;
                            alert('檔案重複：此檔案「' + existing.name + '」已於 ' + existing.upload_time + ' 上傳過，包含 ' + existing.records_count + ' 筆記錄');
                        } else {
                            alert('上傳失敗：' + data.message);
                        }
                    }
                })
                .catch(error => {
                    progressContainer.style.display = 'none';
                    uploadBtn.disabled = false;
                    uploadBtn.innerHTML = '<i class="fas fa-upload me-2"></i>開始上傳';
                    console.error('上傳錯誤:', error);
                    alert('上傳失敗：' + error.message);
                });
            }); // 移除不正確的 once 參數
        });
        
        // 顯示錯誤訊息
        function showError(message) {
            document.getElementById('errorMessage').textContent = message;
            const modal = new bootstrap.Modal(document.getElementById('errorModal'));
            modal.show();
        }
        
        // 快速刪除記錄
        function deleteQuickRecord(uploadId) {
            if (confirm('確定要刪除此上傳記錄嗎？\n\n⚠️ 警告：這將同時還原（刪除）該次上傳所產生的所有業務資料。此操作無法復原！')) {
                fetch(`/erp/upload/delete/${uploadId}/`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // 顯示成功訊息
                        alert(data.message);
                        // 重新載入頁面以更新記錄列表
                        location.reload();
                    } else {
                        alert('刪除失敗: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('刪除時發生錯誤');
                });
            }
        }
    </script>
</body>
</html>
