<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>上傳歷史 - ERP 系統</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            font-family: 'Arial', sans-serif;
            min-height: 100vh;
        }
        
        .upload-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 0;
            margin-bottom: 30px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .btn-nav {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            margin-left: 5px;
            transition: all 0.3s ease;
        }
        
        .btn-nav:hover {
            background: rgba(255, 255, 255, 0.3);
            color: white;
            transform: translateY(-1px);
        }
        
        .history-card {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
            margin-bottom: 25px;
        }
        
        .status-badge {
            padding: 6px 15px;
            border-radius: 20px;
            font-size: 0.875rem;
            font-weight: 500;
        }
        
        .status-success { background: #d4edda; color: #155724; }
        .status-failed { background: #f8d7da; color: #721c24; }
        .status-pending { background: #fff3cd; color: #856404; }
        .status-duplicate { background: #d1ecf1; color: #0c5460; }
        
        .file-type-badge {
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 500;
        }
        
        .type-green-bean { background: #d4edda; color: #155724; }
        .type-raw-material { background: #cce5ff; color: #004085; }
        .type-monthly-summary { background: #fff3cd; color: #856404; }
        
        .table-hover tbody tr:hover {
            background-color: #f8f9fa;
        }
        
        .btn-action {
            padding: 4px 8px;
            font-size: 0.8rem;
            border-radius: 15px;
        }
        
        .stats-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        
        .stats-number {
            font-size: 2rem;
            font-weight: bold;
            color: #667eea;
        }
        
        .stats-label {
            color: #6c757d;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <!-- 頂部導航 -->
    <nav class="navbar navbar-expand-lg upload-header">
        <div class="container">
            <span class="navbar-brand">
                <i class="fas fa-history me-2"></i>
                上傳歷史記錄
            </span>
            <div class="ms-auto">
                <a href="/erp/clean/" class="btn btn-nav btn-sm">
                    <i class="fas fa-chart-line me-1"></i> 返回儀表板
                </a>
                <a href="/erp/upload/" class="btn btn-nav btn-sm">
                    <i class="fas fa-upload me-1"></i> 檔案上傳
                </a>
                <button type="button" class="btn btn-nav btn-sm" onclick="location.reload()">
                    <i class="fas fa-sync-alt me-1"></i> 刷新
                </button>
            </div>
        </div>
    </nav>

    <!-- 主要內容 -->
    <div class="container">
        <!-- CSRF Token for AJAX requests -->
        <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">
        
        <!-- 統計摘要 -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="stats-card">
                    <div class="stats-number">{{ uploads|length }}</div>
                    <div class="stats-label">總上傳數</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card">
                    <div class="stats-number text-success" id="successCount">0</div>
                    <div class="stats-label">成功</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card">
                    <div class="stats-number text-danger" id="failedCount">0</div>
                    <div class="stats-label">失敗</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card">
                    <div class="stats-number text-warning" id="pendingCount">0</div>
                    <div class="stats-label">處理中</div>
                </div>
            </div>
        </div>

        <!-- 上傳歷史表格 -->
        <div class="history-card">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h4>
                    <i class="fas fa-list text-primary me-2"></i>
                    上傳記錄
                </h4>
                <div>
                    <button class="btn btn-outline-primary btn-sm me-2" onclick="toggleSelectAll()" id="selectAllBtn">
                        <i class="fas fa-check-square me-1"></i> 全選
                    </button>
                    <button class="btn btn-outline-warning btn-sm me-2" onclick="batchDeleteSelected()" id="batchDeleteBtn" disabled>
                        <i class="fas fa-trash-alt me-1"></i> 刪除選中
                    </button>
                    <button class="btn btn-outline-danger btn-sm" onclick="clearAllRecords()" {% if not uploads %}disabled{% endif %}>
                        <i class="fas fa-trash me-1"></i> 清空記錄
                    </button>
                </div>
            </div>
            
            {% if uploads %}
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead class="table-light">
                        <tr>
                            <th width="50">
                                <input type="checkbox" id="selectAllCheckbox" onchange="toggleSelectAll()">
                            </th>
                            <th>檔案名稱</th>
                            <th>類型</th>
                            <th>大小</th>
                            <th>上傳時間</th>
                            <th>狀態</th>
                            <th>記錄筆數</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for upload in uploads %}
                        <tr>
                            <td>
                                <input type="checkbox" class="record-checkbox" value="{{ upload.id }}" onchange="updateBatchDeleteButton()">
                            </td>
                            <td>
                                <i class="fas fa-file-excel text-success me-2"></i>
                                {{ upload.file_name }}
                            </td>
                            <td>
                                {% if upload.file_type == 'green_bean' %}
                                    <span class="file-type-badge type-green-bean">生豆入庫</span>
                                {% elif upload.file_type == 'raw_material' %}
                                    <span class="file-type-badge type-raw-material">原料倉管</span>
                                {% elif upload.file_type == 'monthly_summary' %}
                                    <span class="file-type-badge type-monthly-summary">月度統計</span>
                                {% else %}
                                    <span class="file-type-badge">{{ upload.file_type }}</span>
                                {% endif %}
                            </td>
                            <td>{{ upload.file_size|filesizeformat }}</td>
                            <td>{{ upload.upload_time|date:"Y-m-d H:i" }}</td>
                            <td>
                                {% if upload.status == 'success' %}
                                    <span class="status-badge status-success">
                                        <i class="fas fa-check-circle me-1"></i>成功
                                    </span>
                                {% elif upload.status == 'failed' %}
                                    <span class="status-badge status-failed">
                                        <i class="fas fa-times-circle me-1"></i>失敗
                                    </span>
                                {% elif upload.status == 'pending' %}
                                    <span class="status-badge status-pending">
                                        <i class="fas fa-clock me-1"></i>處理中
                                    </span>
                                {% else %}
                                    <span class="status-badge">{{ upload.status }}</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if upload.records_count %}
                                    <span class="badge bg-info">{{ upload.records_count }} 筆</span>
                                {% else %}
                                    <span class="text-muted">0 筆</span>
                                {% endif %}
                            </td>
                            <td>
                                <button class="btn btn-outline-primary btn-action" onclick="viewDetails('{{ upload.id }}')" title="查看詳情">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn btn-outline-danger btn-action ms-1" onclick="deleteRecord('{{ upload.id }}')" title="刪除記錄">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="text-center py-5">
                <i class="fas fa-inbox text-muted" style="font-size: 3rem;"></i>
                <h5 class="mt-3 text-muted">暫無上傳記錄</h5>
                <p class="text-muted">開始上傳您的第一個檔案</p>
                <a href="/erp/upload/" class="btn btn-primary">
                    <i class="fas fa-upload me-2"></i>立即上傳
                </a>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- 詳情模態框 -->
    <div class="modal fade" id="detailModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-info-circle me-2"></i>
                        上傳詳情
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="detailContent">
                    <!-- 詳情內容將通過 JavaScript 載入 -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">關閉</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 確認刪除模態框 -->
    <div class="modal fade" id="deleteModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title text-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        確認刪除
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>您確定要刪除此上傳記錄嗎？</p>
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>注意：</strong>刪除上傳記錄將同時還原（刪除）該次上傳所產生的所有業務資料，包括生豆入庫記錄、原料倉管理記錄等。此操作無法復原。
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-danger" id="confirmDeleteBtn">確認刪除</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // 計算統計數據
        document.addEventListener('DOMContentLoaded', function() {
            calculateStats();
        });

        function calculateStats() {
            const rows = document.querySelectorAll('tbody tr');
            let successCount = 0;
            let failedCount = 0;
            let pendingCount = 0;

            rows.forEach(row => {
                const statusElement = row.querySelector('.status-badge');
                if (statusElement) {
                    if (statusElement.classList.contains('status-success')) {
                        successCount++;
                    } else if (statusElement.classList.contains('status-failed')) {
                        failedCount++;
                    } else if (statusElement.classList.contains('status-pending')) {
                        pendingCount++;
                    }
                }
            });

            document.getElementById('successCount').textContent = successCount;
            document.getElementById('failedCount').textContent = failedCount;
            document.getElementById('pendingCount').textContent = pendingCount;
        }

        function viewDetails(uploadId) {
            // 這裡可以實作查看詳情的功能
            document.getElementById('detailContent').innerHTML = `
                <div class="text-center">
                    <i class="fas fa-spinner fa-spin fa-2x text-primary"></i>
                    <p class="mt-2">載入中...</p>
                </div>
            `;
            
            const modal = new bootstrap.Modal(document.getElementById('detailModal'));
            modal.show();
            
            // 模擬載入詳情（實際應用中應該發送 AJAX 請求）
            setTimeout(() => {
                document.getElementById('detailContent').innerHTML = `
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        上傳記錄 ID: ${uploadId}
                    </div>
                    <p>詳細資訊載入功能待開發...</p>
                `;
            }, 1000);
        }

        let currentDeleteId = null;

        function deleteRecord(uploadId) {
            currentDeleteId = uploadId;
            const modal = new bootstrap.Modal(document.getElementById('deleteModal'));
            modal.show();
        }

        document.getElementById('confirmDeleteBtn').addEventListener('click', function() {
            if (currentDeleteId) {
                // 發送刪除請求
                fetch(`/erp/upload/delete/${currentDeleteId}/`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert(data.message);
                        location.reload(); // 重新載入頁面
                    } else {
                        alert('刪除失敗: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('刪除時發生錯誤');
                });

                // 關閉模態框
                const modal = bootstrap.Modal.getInstance(document.getElementById('deleteModal'));
                modal.hide();
                currentDeleteId = null;
            }
        });

        function clearAllRecords() {
            if (confirm('您確定要清空所有上傳記錄嗎？\n\n⚠️ 警告：這將刪除所有上傳記錄並還原（刪除）所有相關的業務資料，包括生豆入庫記錄、原料倉管理記錄等。此操作無法復原！')) {
                fetch('/erp/upload/clear-all/', {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert(data.message);
                        location.reload();
                    } else {
                        alert('清空失敗: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('清空時發生錯誤');
                });
            }
        }

        // 全選/取消全選功能
        function toggleSelectAll() {
            const selectAllCheckbox = document.getElementById('selectAllCheckbox');
            const recordCheckboxes = document.querySelectorAll('.record-checkbox');
            
            recordCheckboxes.forEach(checkbox => {
                checkbox.checked = selectAllCheckbox.checked;
            });
            
            updateBatchDeleteButton();
            updateSelectAllButton();
        }

        // 更新批量刪除按鈕狀態
        function updateBatchDeleteButton() {
            const checkedBoxes = document.querySelectorAll('.record-checkbox:checked');
            const batchDeleteBtn = document.getElementById('batchDeleteBtn');
            
            if (checkedBoxes.length > 0) {
                batchDeleteBtn.disabled = false;
                batchDeleteBtn.innerHTML = `<i class="fas fa-trash-alt me-1"></i> 刪除選中 (${checkedBoxes.length})`;
            } else {
                batchDeleteBtn.disabled = true;
                batchDeleteBtn.innerHTML = '<i class="fas fa-trash-alt me-1"></i> 刪除選中';
            }
            
            updateSelectAllCheckbox();
        }

        // 更新全選複選框狀態
        function updateSelectAllCheckbox() {
            const recordCheckboxes = document.querySelectorAll('.record-checkbox');
            const checkedBoxes = document.querySelectorAll('.record-checkbox:checked');
            const selectAllCheckbox = document.getElementById('selectAllCheckbox');
            
            if (checkedBoxes.length === recordCheckboxes.length && recordCheckboxes.length > 0) {
                selectAllCheckbox.checked = true;
                selectAllCheckbox.indeterminate = false;
            } else if (checkedBoxes.length > 0) {
                selectAllCheckbox.checked = false;
                selectAllCheckbox.indeterminate = true;
            } else {
                selectAllCheckbox.checked = false;
                selectAllCheckbox.indeterminate = false;
            }
        }

        // 更新全選按鈕文字
        function updateSelectAllButton() {
            const selectAllBtn = document.getElementById('selectAllBtn');
            const selectAllCheckbox = document.getElementById('selectAllCheckbox');
            
            if (selectAllCheckbox.checked) {
                selectAllBtn.innerHTML = '<i class="fas fa-square me-1"></i> 取消全選';
            } else {
                selectAllBtn.innerHTML = '<i class="fas fa-check-square me-1"></i> 全選';
            }
        }

        // 批量刪除選中的記錄
        function batchDeleteSelected() {
            const checkedBoxes = document.querySelectorAll('.record-checkbox:checked');
            if (checkedBoxes.length === 0) {
                alert('請選擇要刪除的記錄');
                return;
            }

            const uploadIds = Array.from(checkedBoxes).map(checkbox => checkbox.value);
            const confirmMessage = `您確定要刪除選中的 ${uploadIds.length} 筆記錄嗎？\n\n⚠️ 警告：這將同時還原（刪除）這些上傳所產生的所有業務資料。此操作無法復原！`;
            
            if (confirm(confirmMessage)) {
                fetch('/erp/upload/batch-delete/', {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        upload_ids: uploadIds
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert(data.message);
                        location.reload();
                    } else {
                        alert('批量刪除失敗: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('批量刪除時發生錯誤');
                });
            }
        }
    </script>
</body>
</html>
