<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>權限管理 - ERP 系統</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
            font-family: 'Microsoft JhengHei', sans-serif;
        }
        
        .header-section {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem 0;
            margin-bottom: 2rem;
        }
        
        .stats-card {
            background: white;
            border-radius: 10px;
            padding: 1.5rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border-left: 4px solid #007bff;
        }
        
        .permission-matrix {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .permission-header {
            background: #f8f9fa;
            padding: 1rem;
            border-bottom: 2px solid #dee2e6;
        }
        
        .user-row {
            border-bottom: 1px solid #dee2e6;
            padding: 1rem;
            transition: background-color 0.2s;
        }
        
        .user-row:hover {
            background-color: #f8f9fa;
        }
        
        .permission-toggle {
            width: 80px;
            text-align: center;
        }
        
        .permission-select {
            width: 100px;
            font-size: 0.875rem;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .user-avatar {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }
        
        .feature-header {
            writing-mode: vertical-rl;
            text-orientation: mixed;
            min-width: 100px;
            text-align: center;
            padding: 0.5rem;
            font-size: 0.875rem;
            font-weight: 600;
        }
        
        .btn-save-all {
            position: fixed;
            bottom: 30px;
            right: 30px;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        
        @media (max-width: 768px) {
            .permission-matrix {
                overflow-x: auto;
            }
            
            .feature-header {
                writing-mode: horizontal-tb;
                min-width: 80px;
                font-size: 0.75rem;
            }
            
            .permission-select {
                width: 80px;
                font-size: 0.75rem;
            }
        }
    </style>
</head>
<body>
    <!-- 頁面標題 -->
    <div class="header-section">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h1 class="h2 mb-0">
                        <i class="fas fa-shield-alt me-2"></i>
                        權限管理系統
                    </h1>
                    <p class="mb-0 mt-2 opacity-75">管理系統用戶的功能權限設定</p>
                </div>
                <div class="col-md-4 text-md-end mt-3 mt-md-0">
                    <div class="text-white">
                        <small>目前登入：{{ user.username }}</small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- 統計資訊 -->
        <div class="row mb-4">
            <div class="col-md-4 mb-3">
                <div class="stats-card">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h5 class="text-muted mb-1">總用戶數</h5>
                            <h3 class="mb-0">{{ total_users }}</h3>
                        </div>
                        <div class="text-primary">
                            <i class="fas fa-users fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4 mb-3">
                <div class="stats-card">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h5 class="text-muted mb-1">系統功能</h5>
                            <h3 class="mb-0">6</h3>
                        </div>
                        <div class="text-success">
                            <i class="fas fa-cogs fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4 mb-3">
                <div class="stats-card">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h5 class="text-muted mb-1">權限設定</h5>
                            <h3 class="mb-0">{{ total_permissions }}</h3>
                        </div>
                        <div class="text-warning">
                            <i class="fas fa-key fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 權限矩陣 -->
        <div class="permission-matrix">
            <div class="permission-header">
                <div class="row align-items-center">
                    <div class="col-md-6">
                        <h5 class="mb-0">
                            <i class="fas fa-table me-2"></i>
                            權限設定矩陣
                        </h5>
                    </div>
                    <div class="col-md-6 text-md-end">
                        <div class="btn-group" role="group">
                            <button type="button" class="btn btn-outline-success btn-sm" onclick="setAllPermissions('edit')">
                                全部設為編輯
                            </button>
                            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="setAllPermissions('none')">
                                全部清除
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 表頭 -->
            <div class="row g-0 bg-light border-bottom">
                <div class="col-3 p-3">
                    <strong>用戶</strong>
                </div>
                <div class="col-9">
                    <div class="row g-0 text-center">
                        <div class="col feature-header border-start">生豆入庫記錄</div>
                        <div class="col feature-header border-start">原料倉管理</div>
                        <div class="col feature-header border-start">月度統計</div>
                        <div class="col feature-header border-start">系統用戶</div>
                        <div class="col feature-header border-start">管理員</div>
                        <div class="col feature-header border-start">權限管理</div>
                    </div>
                </div>
            </div>

            <!-- 用戶權限列表 -->
            <div id="userPermissionsList">
                {% for user in page_obj %}
                <div class="user-row" data-user-id="{{ user.id }}">
                    <div class="row g-0 align-items-center">
                        <div class="col-3">
                            <div class="user-info">
                                <div class="user-avatar">
                                    {{ user.username|first|upper }}
                                </div>
                                <div>
                                    <div class="fw-bold">{{ user.username }}</div>
                                    <small class="text-muted">
                                        {% if user.first_name or user.last_name %}
                                            {{ user.first_name }} {{ user.last_name }}
                                        {% else %}
                                            {{ user.email|default:"無信箱" }}
                                        {% endif %}
                                    </small>
                                </div>
                            </div>
                        </div>
                        <div class="col-9">
                            <div class="row g-0">
                                <!-- 生豆入庫記錄 -->
                                <div class="col text-center border-start p-2">
                                    <select class="form-select form-select-sm permission-select" 
                                            data-feature="green_bean_records" 
                                            data-user="{{ user.id }}">
                                        <option value="none">無權限</option>
                                        <option value="edit">編輯</option>
                                    </select>
                                </div>
                                <!-- 原料倉管理 -->
                                <div class="col text-center border-start p-2">
                                    <select class="form-select form-select-sm permission-select" 
                                            data-feature="raw_material_management" 
                                            data-user="{{ user.id }}">
                                        <option value="none">無權限</option>
                                        <option value="edit">編輯</option>
                                    </select>
                                </div>
                                <!-- 月度統計 -->
                                <div class="col text-center border-start p-2">
                                    <select class="form-select form-select-sm permission-select" 
                                            data-feature="monthly_statistics" 
                                            data-user="{{ user.id }}">
                                        <option value="none">無權限</option>
                                        <option value="edit">編輯</option>
                                    </select>
                                </div>
                                <!-- 系統用戶 -->
                                <div class="col text-center border-start p-2">
                                    <select class="form-select form-select-sm permission-select" 
                                            data-feature="system_users" 
                                            data-user="{{ user.id }}">
                                        <option value="none">無權限</option>
                                        <option value="edit">編輯</option>
                                    </select>
                                </div>
                                <!-- 管理員 -->
                                <div class="col text-center border-start p-2">
                                    <select class="form-select form-select-sm permission-select" 
                                            data-feature="admin_management" 
                                            data-user="{{ user.id }}">
                                        <option value="none">無權限</option>
                                        <option value="edit">編輯</option>
                                    </select>
                                </div>
                                <!-- 權限管理 -->
                                <div class="col text-center border-start p-2">
                                    <select class="form-select form-select-sm permission-select" 
                                            data-feature="permission_management" 
                                            data-user="{{ user.id }}">
                                        <option value="none">無權限</option>
                                        <option value="edit">編輯</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% empty %}
                <div class="text-center py-5">
                    <i class="fas fa-users fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted">尚無用戶資料</h5>
                    <p class="text-muted">請先建立用戶帳號</p>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- 分頁 -->
        {% if page_obj.has_other_pages %}
        <nav aria-label="分頁導覽" class="mt-4">
            <ul class="pagination justify-content-center">
                {% if page_obj.has_previous %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}">
                            <i class="fas fa-chevron-left"></i> 上一頁
                        </a>
                    </li>
                {% endif %}
                
                {% for num in page_obj.paginator.page_range %}
                    {% if page_obj.number == num %}
                        <li class="page-item active">
                            <span class="page-link">{{ num }}</span>
                        </li>
                    {% else %}
                        <li class="page-item">
                            <a class="page-link" href="?page={{ num }}{% if search_query %}&search={{ search_query }}{% endif %}">{{ num }}</a>
                        </li>
                    {% endif %}
                {% endfor %}
                
                {% if page_obj.has_next %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ page_obj.next_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}">
                            下一頁 <i class="fas fa-chevron-right"></i>
                        </a>
                    </li>
                {% endif %}
            </ul>
        </nav>
        {% endif %}
    </div>

    <!-- 浮動保存按鈕 -->
    <button type="button" class="btn btn-primary btn-lg btn-save-all" onclick="saveAllPermissions()">
        <i class="fas fa-save me-2"></i>
        保存所有設定
    </button>

    <!-- 提示訊息 -->
    <div class="position-fixed top-0 end-0 p-3" style="z-index: 1050;">
        <div id="alertContainer"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // 存儲用戶權限數據
        let userPermissions = {};
        
        // 載入現有權限
        document.addEventListener('DOMContentLoaded', function() {
            loadUserPermissions();
        });

        // 載入用戶權限
        function loadUserPermissions() {
            const userRows = document.querySelectorAll('.user-row');
            userRows.forEach(row => {
                const userId = row.dataset.userId;
                userPermissions[userId] = {};
                
                // 載入每個用戶的權限設定
                fetch(`/erp/permissions/user/${userId}/api/`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            const permissions = data.permissions;
                            
                            // 設定下拉選單的值
                            row.querySelectorAll('.permission-select').forEach(select => {
                                const feature = select.dataset.feature;
                                if (permissions[feature]) {
                                    select.value = permissions[feature].permission_type;
                                    userPermissions[userId][feature] = permissions[feature].permission_type;
                                } else {
                                    select.value = 'none';
                                    userPermissions[userId][feature] = 'none';
                                }
                            });
                        }
                    })
                    .catch(error => {
                        console.error('載入權限失敗:', error);
                    });
            });
        }

        // 監聽權限變更
        document.addEventListener('change', function(e) {
            if (e.target.classList.contains('permission-select')) {
                const userId = e.target.dataset.user;
                const feature = e.target.dataset.feature;
                const permission = e.target.value;
                
                if (!userPermissions[userId]) {
                    userPermissions[userId] = {};
                }
                userPermissions[userId][feature] = permission;
            }
        });

        // 設定所有權限
        function setAllPermissions(permissionType) {
            document.querySelectorAll('.permission-select').forEach(select => {
                select.value = permissionType;
                
                const userId = select.dataset.user;
                const feature = select.dataset.feature;
                
                if (!userPermissions[userId]) {
                    userPermissions[userId] = {};
                }
                userPermissions[userId][feature] = permissionType;
            });
            
            showAlert('已設定所有權限為：' + getPermissionText(permissionType), 'info');
        }

        // 保存所有權限設定
        function saveAllPermissions() {
            const saveButton = document.querySelector('.btn-save-all');
            saveButton.disabled = true;
            saveButton.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>保存中...';
            
            fetch('/erp/permissions/batch-update/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    users_permissions: userPermissions
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showAlert('權限設定保存成功！', 'success');
                } else {
                    showAlert('保存失敗：' + data.message, 'danger');
                }
            })
            .catch(error => {
                console.error('保存失敗:', error);
                showAlert('保存時發生錯誤', 'danger');
            })
            .finally(() => {
                saveButton.disabled = false;
                saveButton.innerHTML = '<i class="fas fa-save me-2"></i>保存所有設定';
            });
        }

        // 顯示提示訊息
        function showAlert(message, type) {
            const alertContainer = document.getElementById('alertContainer');
            const alertId = 'alert-' + Date.now();
            
            const alertHTML = `
                <div id="${alertId}" class="alert alert-${type} alert-dismissible fade show" role="alert">
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
            
            alertContainer.insertAdjacentHTML('beforeend', alertHTML);
            
            // 自動消失
            setTimeout(() => {
                const alert = document.getElementById(alertId);
                if (alert) {
                    const bsAlert = new bootstrap.Alert(alert);
                    bsAlert.close();
                }
            }, 5000);
        }

        // 獲取權限文字
        function getPermissionText(permission) {
            switch(permission) {
                case 'edit': return '編輯';
                case 'none': return '無權限';
                default: return permission;
            }
        }

        // 獲取 CSRF Token
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
    </script>
</body>
</html>
