<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>生豆入庫記錄 - Excel 上傳</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            font-family: 'Arial', sans-serif;
            min-height: 100vh;
        }
        
        .upload-container {
            background: white;
            border-radius: 15px;
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
            margin: 50px auto;
            max-width: 800px;
            padding: 40px;
        }
        
        .upload-header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .upload-header h1 {
            color: #2c3e50;
            margin-bottom: 10px;
        }
        
        .upload-area {
            border: 2px dashed #bdc3c7;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            margin-bottom: 30px;
            transition: all 0.3s ease;
        }
        
        .upload-area:hover {
            border-color: #3498db;
            background-color: #f8f9fa;
        }
        
        .upload-area.dragover {
            border-color: #27ae60;
            background-color: #ecf0f1;
        }
        
        .upload-icon {
            font-size: 48px;
            color: #bdc3c7;
            margin-bottom: 20px;
        }
        
        .upload-text {
            color: #7f8c8d;
            margin-bottom: 20px;
        }
        
        .file-input {
            display: none;
        }
        
        .browse-btn {
            background-color: #3498db;
            border: none;
            color: white;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        .browse-btn:hover {
            background-color: #2980b9;
        }
        
        .upload-btn {
            background-color: #27ae60;
            border: none;
            color: white;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.3s;
            width: 100%;
            margin-top: 20px;
        }
        
        .upload-btn:hover {
            background-color: #229954;
        }
        
        .upload-btn:disabled {
            background-color: #bdc3c7;
            cursor: not-allowed;
        }
        
        .file-info {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
            display: none;
        }
        
        .progress-container {
            margin-top: 20px;
            display: none;
        }
        
        .upload-records {
            margin-top: 40px;
        }
        
        .record-item {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            border-left: 4px solid #3498db;
        }
        
        .record-success {
            border-left-color: #27ae60;
        }
        
        .record-error {
            border-left-color: #e74c3c;
        }
        
        .record-warning {
            border-left-color: #f39c12;
        }
        
        .btn-group-vertical .btn {
            margin-bottom: 2px;
        }
        
        .record-item {
            transition: all 0.2s ease;
        }
        
        .record-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .back-btn {
            background: linear-gradient(45deg, #95a5a6, #bdc3c7);
            border: none;
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
        }
        
        .back-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            color: white;
            text-decoration: none;
        }
        
        .back-btn[style*="background-color: #e67e22"] {
            background: linear-gradient(45deg, #e67e22, #f39c12) !important;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="upload-container">
            <!-- 返回按鈕群組 -->
            <div class="d-flex gap-2 mb-3">
                <a href="/admin/app/greenbeaninboundrecord/" class="back-btn">
                    <i class="fas fa-arrow-left"></i> 上一頁
                </a>
            </div>
            
            <!-- 標題 -->
            <div class="upload-header">
                <h1><i class="fas fa-upload"></i> 生豆入庫記錄上傳</h1>
                <p class="text-muted">支援 Excel (.xlsx, .xls) 格式檔案</p>
            </div>
            
            <!-- 上傳區域 -->
            <div class="upload-area" id="uploadArea">
                <div class="upload-icon">
                    <i class="fas fa-cloud-upload-alt"></i>
                </div>
                <div class="upload-text">
                    <h5>拖放 Excel 檔案到此處，或點擊瀏覽</h5>
                    <p>支援 .xlsx 和 .xls 格式，檔案大小限制 5MB</p>
                </div>
                <input type="file" id="fileInput" class="file-input" accept=".xlsx,.xls">
                <button type="button" class="browse-btn" onclick="document.getElementById('fileInput').click()">
                    <i class="fas fa-folder-open"></i> 瀏覽檔案
                </button>
            </div>
            
            <!-- 檔案資訊 -->
            <div class="file-info" id="fileInfo">
                <h6><i class="fas fa-file-excel"></i> 選中的檔案</h6>
                <p id="fileName"></p>
                <p id="fileSize"></p>
            </div>
            
            <!-- 上傳按鈕 -->
            <button type="button" class="upload-btn" id="uploadBtn" disabled>
                <i class="fas fa-upload"></i> 開始上傳
            </button>
            
            <!-- 進度條 -->
            <div class="progress-container" id="progressContainer">
                <div class="progress">
                    <div class="progress-bar" id="progressBar" role="progressbar" style="width: 0%"></div>
                </div>
                <p class="text-center mt-2" id="progressText">準備上傳...</p>
            </div>
            
            <!-- 結果顯示 -->
            <div id="resultContainer" style="margin-top: 20px;"></div>
        </div>
        
        <!-- 最近上傳記錄 -->
        <div class="upload-container">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h3><i class="fas fa-history"></i> 上傳記錄管理</h3>
                <div>
                    <button onclick="loadUploadRecords()" class="btn btn-outline-primary btn-sm">
                        <i class="fas fa-sync"></i> 重新整理
                    </button>
                    <a href="/admin/app/fileuploadrecord/" target="_blank" class="btn btn-outline-info btn-sm">
                        <i class="fas fa-external-link-alt"></i> 詳細管理
                    </a>
                </div>
            </div>
            
            <!-- 記錄篩選 -->
            <div class="row mb-3">
                <div class="col-md-4">
                    <select id="statusFilter" class="form-select form-select-sm" onchange="filterRecords()">
                        <option value="">所有狀態</option>
                        <option value="success">成功</option>
                        <option value="failed">失敗</option>
                        <option value="pending">處理中</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <input type="date" id="dateFilter" class="form-control form-control-sm" onchange="filterRecords()">
                </div>
                <div class="col-md-4">
                    <input type="text" id="searchFilter" class="form-control form-control-sm" placeholder="搜尋檔案名稱..." onchange="filterRecords()">
                </div>
            </div>
            
            <div id="uploadRecords">
                <p class="text-center text-muted">載入中...</p>
            </div>
            
            <!-- 分頁控制 -->
            <nav aria-label="上傳記錄分頁" id="recordsPagination" style="display: none;">
                <ul class="pagination pagination-sm justify-content-center">
                    <!-- 分頁項目將由 JavaScript 動態生成 -->
                </ul>
            </nav>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let selectedFile = null;
        
        // 檔案輸入處理
        const fileInput = document.getElementById('fileInput');
        const uploadArea = document.getElementById('uploadArea');
        const fileInfo = document.getElementById('fileInfo');
        const uploadBtn = document.getElementById('uploadBtn');
        
        // 拖拽處理
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });
        
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });
        
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFileSelect(files[0]);
            }
        });
        
        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFileSelect(e.target.files[0]);
            }
        });
        
        function handleFileSelect(file) {
            // 檢查檔案格式
            if (!file.name.toLowerCase().match(/\.(xlsx|xls)$/)) {
                alert('請選擇 Excel 檔案 (.xlsx 或 .xls)');
                return;
            }
            
            // 檢查檔案大小 (5MB)
            if (file.size > 5 * 1024 * 1024) {
                alert('檔案大小不能超過 5MB');
                return;
            }
            
            selectedFile = file;
            
            // 顯示檔案資訊
            document.getElementById('fileName').textContent = file.name;
            document.getElementById('fileSize').textContent = `檔案大小: ${(file.size / 1024 / 1024).toFixed(2)} MB`;
            fileInfo.style.display = 'block';
            uploadBtn.disabled = false;
        }
        
        // 上傳處理
        uploadBtn.addEventListener('click', uploadFile);
        
        function uploadFile() {
            if (!selectedFile) return;
            
            const formData = new FormData();
            formData.append('file', selectedFile);
            
            // 顯示進度條
            const progressContainer = document.getElementById('progressContainer');
            const progressBar = document.getElementById('progressBar');
            const progressText = document.getElementById('progressText');
            
            progressContainer.style.display = 'block';
            uploadBtn.disabled = true;
            
            // 取得 CSRF token
            const csrfToken = getCookie('csrftoken');
            
            fetch('/erp/green-bean-records/upload-file/', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': csrfToken
                }
            })
            .then(response => response.json())
            .then(data => {
                progressBar.style.width = '100%';
                progressText.textContent = '上傳完成';
                
                // 顯示結果
                showResult(data);
                
                // 重置表單
                resetForm();
                
                // 重新載入上傳記錄
                loadUploadRecords();
            })
            .catch(error => {
                console.error('上傳錯誤:', error);
                showResult({
                    success: false,
                    message: '上傳過程中發生錯誤，請稍後重試'
                });
                resetForm();
            });
        }
        
        function showResult(data) {
            const resultContainer = document.getElementById('resultContainer');
            
            if (data.success) {
                resultContainer.innerHTML = `
                    <div class="alert alert-success">
                        <h6><i class="fas fa-check-circle"></i> 上傳成功</h6>
                        <p>${data.message}</p>
                        ${data.records_count ? `<p>成功導入 ${data.records_count} 筆記錄</p>` : ''}
                    </div>
                `;
            } else {
                resultContainer.innerHTML = `
                    <div class="alert alert-danger">
                        <h6><i class="fas fa-exclamation-circle"></i> 上傳失敗</h6>
                        <p>${data.message || '未知錯誤'}</p>
                        ${data.errors ? `<pre style="white-space: pre-wrap;">${data.errors}</pre>` : ''}
                    </div>
                `;
            }
        }
        
        function resetForm() {
            selectedFile = null;
            fileInput.value = '';
            fileInfo.style.display = 'none';
            document.getElementById('progressContainer').style.display = 'none';
            document.getElementById('progressBar').style.width = '0%';
            uploadBtn.disabled = true;
        }
        
        // 全域變數
        let allRecords = [];
        let filteredRecords = [];
        let currentPage = 1;
        const recordsPerPage = 5;
        
        // 載入上傳記錄
        function loadUploadRecords() {
            fetch('/erp/green-bean-records/uploads/')
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.uploads) {
                        allRecords = data.uploads;
                        filteredRecords = [...allRecords];
                        currentPage = 1;
                        displayRecords();
                    } else {
                        document.getElementById('uploadRecords').innerHTML = '<p class="text-center text-muted">暫無上傳記錄</p>';
                    }
                })
                .catch(error => {
                    console.error('載入上傳記錄失敗:', error);
                    document.getElementById('uploadRecords').innerHTML = '<p class="text-center text-danger">載入失敗</p>';
                });
        }
        
        // 顯示記錄
        function displayRecords() {
            const recordsContainer = document.getElementById('uploadRecords');
            const startIndex = (currentPage - 1) * recordsPerPage;
            const endIndex = startIndex + recordsPerPage;
            const pageRecords = filteredRecords.slice(startIndex, endIndex);
            
            if (pageRecords.length > 0) {
                recordsContainer.innerHTML = pageRecords.map(upload => `
                    <div class="record-item ${upload.status === 'success' ? 'record-success' : upload.status === 'failed' ? 'record-error' : 'record-warning'}" data-status="${upload.status}" data-date="${upload.upload_time}" data-filename="${upload.file_name.toLowerCase()}">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                <h6><i class="fas fa-file-excel"></i> ${upload.file_name}</h6>
                                <div class="row">
                                    <div class="col-md-6">
                                        <p class="mb-1"><i class="fas fa-clock"></i> 上傳時間: ${upload.upload_time}</p>
                                        <p class="mb-1"><i class="fas fa-info-circle"></i> 狀態: ${upload.status_display || upload.status}</p>
                                    </div>
                                    <div class="col-md-6">
                                        <p class="mb-1"><i class="fas fa-database"></i> 記錄數: ${upload.records_count || 0}</p>
                                        <p class="mb-0"><i class="fas fa-hdd"></i> 檔案大小: ${formatFileSize(upload.file_size || 0)}</p>
                                    </div>
                                </div>
                                ${upload.error_message ? `<p class="text-danger mb-0"><i class="fas fa-exclamation-triangle"></i> ${upload.error_message}</p>` : ''}
                            </div>
                            <div class="text-end ms-3">
                                <span class="badge ${getStatusBadgeClass(upload.status)} mb-2">
                                    ${getStatusText(upload.status)}
                                </span>
                                <br>
                                <div class="btn-group-vertical btn-group-sm">
                                    ${upload.can_delete ? `
                                        <button onclick="deleteUploadRecord('${upload.id}')" class="btn btn-outline-danger btn-sm">
                                            <i class="fas fa-trash"></i> 刪除
                                        </button>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                `).join('');
            } else {
                recordsContainer.innerHTML = '<p class="text-center text-muted">沒有符合條件的記錄</p>';
            }
            
            // 更新分頁
            updatePagination();
        }
        
        // 篩選記錄
        function filterRecords() {
            const statusFilter = document.getElementById('statusFilter').value;
            const dateFilter = document.getElementById('dateFilter').value;
            const searchFilter = document.getElementById('searchFilter').value.toLowerCase();
            
            filteredRecords = allRecords.filter(record => {
                let matchStatus = !statusFilter || record.status === statusFilter;
                let matchDate = !dateFilter || record.upload_time.startsWith(dateFilter);
                let matchSearch = !searchFilter || record.file_name.toLowerCase().includes(searchFilter);
                
                return matchStatus && matchDate && matchSearch;
            });
            
            currentPage = 1;
            displayRecords();
        }
        
        // 更新分頁
        function updatePagination() {
            const totalPages = Math.ceil(filteredRecords.length / recordsPerPage);
            const paginationContainer = document.getElementById('recordsPagination');
            
            if (totalPages <= 1) {
                paginationContainer.style.display = 'none';
                return;
            }
            
            paginationContainer.style.display = 'block';
            const paginationList = paginationContainer.querySelector('.pagination');
            
            let paginationHTML = '';
            
            // 上一頁
            paginationHTML += `
                <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
                    <a class="page-link" href="#" onclick="changePage(${currentPage - 1})">
                        <i class="fas fa-chevron-left"></i>
                    </a>
                </li>
            `;
            
            // 頁碼
            for (let i = 1; i <= totalPages; i++) {
                if (i === 1 || i === totalPages || (i >= currentPage - 1 && i <= currentPage + 1)) {
                    paginationHTML += `
                        <li class="page-item ${i === currentPage ? 'active' : ''}">
                            <a class="page-link" href="#" onclick="changePage(${i})">${i}</a>
                        </li>
                    `;
                } else if (i === currentPage - 2 || i === currentPage + 2) {
                    paginationHTML += '<li class="page-item disabled"><span class="page-link">...</span></li>';
                }
            }
            
            // 下一頁
            paginationHTML += `
                <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
                    <a class="page-link" href="#" onclick="changePage(${currentPage + 1})">
                        <i class="fas fa-chevron-right"></i>
                    </a>
                </li>
            `;
            
            paginationList.innerHTML = paginationHTML;
        }
        
        // 切換頁面
        function changePage(page) {
            const totalPages = Math.ceil(filteredRecords.length / recordsPerPage);
            if (page < 1 || page > totalPages) return;
            
            currentPage = page;
            displayRecords();
        }
        
        // 輔助函數
        function getStatusBadgeClass(status) {
            switch (status) {
                case 'success': return 'bg-success';
                case 'failed': return 'bg-danger';
                case 'pending': return 'bg-warning text-dark';
                default: return 'bg-secondary';
            }
        }
        
        function getStatusText(status) {
            switch (status) {
                case 'success': return '成功';
                case 'failed': return '失敗';
                case 'pending': return '處理中';
                default: return '未知';
            }
        }
        
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
        // 刪除上傳記錄
        function deleteUploadRecord(uploadId) {
            if (!confirm('確定要刪除這個上傳記錄嗎？這將同時刪除所有相關的記錄。')) {
                return;
            }
            
            const csrfToken = getCookie('csrftoken');
            
            fetch(`/erp/green-bean-records/upload/delete/${uploadId}/`, {
                method: 'DELETE',
                headers: {
                    'X-CSRFToken': csrfToken
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('刪除成功');
                    loadUploadRecords(); // 重新載入記錄
                } else {
                    alert('刪除失敗: ' + (data.message || '未知錯誤'));
                }
            })
            .catch(error => {
                console.error('刪除錯誤:', error);
                alert('刪除失敗');
            });
        }
        
        // 取得 CSRF token
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        
        // 頁面載入時載入上傳記錄
        document.addEventListener('DOMContentLoaded', loadUploadRecords);
    </script>
</body>
</html>