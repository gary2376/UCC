<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>權限管理</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem 0;
            margin-bottom: 2rem;
        }
        .card {
            border: none;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }
        .stats-card {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border-radius: 10px;
            padding: 1.5rem;
            margin-bottom: 1rem;
        }
        .btn-primary {
            background: linear-gradient(45deg, #667eea, #764ba2);
            border: none;
            border-radius: 5px;
        }
        .btn-primary:hover {
            background: linear-gradient(45deg, #5a6fd8, #6a4190);
        }
        .table {
            background: white;
        }
        .navbar {
            background: rgba(255,255,255,0.95) !important;
            backdrop-filter: blur(10px);
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body>
    <!-- 導航欄 -->
    <nav class="navbar navbar-expand-lg navbar-light bg-light sticky-top">
        <div class="container">
        </div>
    </nav>

    <!-- 標題區 -->
    <div class="header">
        <div class="container">
            <h1 class="mb-0">
                <i class="fas fa-shield-alt me-3"></i>權限管理
                <small class="d-block mt-2 opacity-75">管理使用者功能權限</small>
            </h1>
        </div>
    </div>

    <div class="container">
        <!-- 統計資訊 -->
        <div class="row mb-4">
            <div class="col-md-4">
                <div class="stats-card">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h4>{{ total_users }}</h4>
                            <span>總用戶數</span>
                        </div>
                        <i class="fas fa-users fa-2x opacity-75"></i>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="stats-card">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h4>{{ total_features }}</h4>
                            <span>系統功能數</span>
                        </div>
                        <i class="fas fa-cogs fa-2x opacity-75"></i>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="stats-card">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h4>{{ total_permissions }}</h4>
                            <span>已設定權限數</span>
                        </div>
                        <i class="fas fa-key fa-2x opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- 搜索功能 -->
        <div class="card">
            <div class="card-body">
                <form method="get" class="row g-3">
                    <div class="col-md-8">
                        <label for="search" class="form-label">搜索用戶</label>
                        <input type="text" class="form-control" id="search" name="search" 
                               value="{{ search_query }}" placeholder="輸入用戶名、姓名或郵箱">
                    </div>
                    <div class="col-md-4 d-flex align-items-end">
                        <button type="submit" class="btn btn-primary me-2">
                            <i class="fas fa-search"></i> 搜索
                        </button>
                        <a href="{% url 'erp:permission_management' %}" class="btn btn-outline-secondary">
                            <i class="fas fa-times"></i> 清除
                        </a>
                    </div>
                </form>
            </div>
        </div>

        <!-- 用戶權限列表 -->
        <div class="card">
            <div class="card-header bg-white">
                <h5 class="card-title mb-0">
                    <i class="fas fa-users me-2"></i>用戶權限設定
                </h5>
            </div>
            <div class="card-body">
                {% if page_obj %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>用戶名</th>
                                <th>姓名</th>
                                <th>郵箱</th>
                                <th>已設定權限</th>
                                <th>最後登入</th>
                                <th width="200">操作</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for user in page_obj %}
                            <tr>
                                <td>
                                    <strong>{{ user.username }}</strong>
                                    {% if user.is_active %}
                                        <span class="badge bg-success ms-1">啟用</span>
                                    {% else %}
                                        <span class="badge bg-danger ms-1">停用</span>
                                    {% endif %}
                                </td>
                                <td>{{ user.get_full_name|default:"未設定" }}</td>
                                <td>{{ user.email|default:"未設定" }}</td>
                                <td>
                                    {% with user.featurepermission_set.count as perm_count %}
                                        {% if perm_count > 0 %}
                                            <span class="badge bg-primary">{{ perm_count }} 項權限</span>
                                        {% else %}
                                            <span class="badge bg-secondary">無權限</span>
                                        {% endif %}
                                    {% endwith %}
                                </td>
                                <td>
                                    {% if user.last_login %}
                                        {{ user.last_login|date:"Y-m-d H:i" }}
                                    {% else %}
                                        <span class="text-muted">從未登入</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <a href="{% url 'erp:user_permissions' user.id %}" 
                                       class="btn btn-sm btn-primary">
                                        <i class="fas fa-edit"></i> 編輯權限
                                    </a>
                                    <button type="button" class="btn btn-sm btn-outline-info" 
                                            onclick="showUserPermissions('{{ user.id }}', '{{ user.username }}')">
                                        <i class="fas fa-eye"></i> 查看
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <!-- 分頁 -->
                {% if page_obj.has_other_pages %}
                <nav aria-label="分頁導航" class="mt-4">
                    <ul class="pagination justify-content-center">
                        {% if page_obj.has_previous %}
                            <li class="page-item">
                                <a class="page-link" href="?page=1{% if search_query %}&search={{ search_query }}{% endif %}">首頁</a>
                            </li>
                            <li class="page-item">
                                <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}">上一頁</a>
                            </li>
                        {% endif %}

                        <li class="page-item active">
                            <span class="page-link">
                                第 {{ page_obj.number }} 頁，共 {{ page_obj.paginator.num_pages }} 頁
                            </span>
                        </li>

                        {% if page_obj.has_next %}
                            <li class="page-item">
                                <a class="page-link" href="?page={{ page_obj.next_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}">下一頁</a>
                            </li>
                            <li class="page-item">
                                <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}{% if search_query %}&search={{ search_query }}{% endif %}">末頁</a>
                            </li>
                        {% endif %}
                    </ul>
                </nav>
                {% endif %}
                {% else %}
                <div class="text-center py-5">
                    <i class="fas fa-users fa-4x text-muted mb-3"></i>
                    <h5 class="text-muted">沒有找到符合條件的用戶</h5>
                    <p class="text-muted">請調整搜索條件或添加新用戶</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- 查看用戶權限Modal -->
    <div class="modal fade" id="userPermissionsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-user-shield"></i> 
                        <span id="modalUserName"></span> 的權限設定
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="userPermissionsContent">
                        <div class="text-center">
                            <div class="spinner-border" role="status">
                                <span class="visually-hidden">載入中...</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">關閉</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
    function showUserPermissions(userId, username) {
        $('#modalUserName').text(username);
        $('#userPermissionsModal').modal('show');
        
        // 載入用戶權限
        fetch(`/erp/permissions/user/${userId}/api/`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    let html = '<div class="row">';
                    const permissions = data.permissions;
                    
                    if (Object.keys(permissions).length === 0) {
                        html += '<div class="col-12 text-center"><p class="text-muted">該用戶尚未設定任何權限</p></div>';
                    } else {
                        Object.entries(permissions).forEach(([featureCode, permInfo]) => {
                            const badgeClass = permInfo.permission_type === 'edit' ? 'bg-success' : 'bg-info';
                            const permText = permInfo.permission_type === 'edit' ? '編輯' : '瀏覽';
                            
                            html += `
                                <div class="col-md-6 mb-2">
                                    <div class="d-flex justify-content-between align-items-center p-2 border rounded">
                                        <span>${permInfo.feature_name}</span>
                                        <span class="badge ${badgeClass}">${permText}</span>
                                    </div>
                                </div>
                            `;
                        });
                    }
                    
                    html += '</div>';
                    $('#userPermissionsContent').html(html);
                } else {
                    $('#userPermissionsContent').html('<div class="alert alert-danger">載入權限時發生錯誤</div>');
                }
            })
            .catch(error => {
                $('#userPermissionsContent').html('<div class="alert alert-danger">載入權限時發生錯誤</div>');
            });
    }
    </script>
</body>
</html>
